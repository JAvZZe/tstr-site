---
import { supabase } from '../../lib/supabase'
import { getRedirectUrl } from '../../lib/redirect'
import Footer from '../../components/Footer.astro'

// Disable static prerendering for performance - use SSR instead
export const prerender = false

// Generate static paths for all active listings
export async function getStaticPaths() {
  const { data: listings, error } = await supabase
    .from('listings')
    .select('slug')
    .eq('status', 'active')
    .order('created_at', { ascending: false });

  if (error || !listings) {
    console.error('Error fetching listings for static paths:', error);
    return [];
  }

  return listings.map(listing => ({
    params: { slug: listing.slug }
  }));
}

const { slug } = Astro.params

// Fetch listing with location hierarchy and custom fields
const { data: listing, error } = await supabase
  .from('listings')
  .select(`
    *,
    category:category_id (
      id,
      name,
      slug
    ),
    location:location_id (
      id,
      name,
      slug,
      level,
      parent:parent_id (
        id,
        name,
        slug,
        level,
        parent:parent_id (
          id,
          name,
          slug,
          level
        )
      )
    )
  `)
  .eq('slug', slug)
  .eq('status', 'active')
  .single()

if (error || !listing) {
  return Astro.redirect('/browse')
}

// Fetch custom field values
const { data: customFieldValues, error: cfError } = await supabase
  .from('listing_custom_fields')
  .select(`
    value,
    custom_field:custom_field_id (
      field_name,
      field_type,
      field_label,
      options
    )
  `)
  .eq('listing_id', listing.id)

// Fetch listing capabilities (standards/certifications)
const { data: capabilities, error: capError } = await supabase
  .from('listing_capabilities')
  .select(`
    standard:standard_id (
      code,
      name,
      description
    )
  `)
  .eq('listing_id', listing.id)
  .order('created_at', { ascending: true })

// Build location breadcrumb
const getLocationHierarchy = (location) => {
  if (!location) return []
  const hierarchy = []

  if (location.parent?.parent?.level === 'country') {
    hierarchy.push({ name: location.parent.parent.name, slug: location.parent.parent.slug, level: 'country' })
  }
  if (location.parent?.level === 'state') {
    hierarchy.push({ name: location.parent.name, slug: location.parent.slug, level: 'state' })
  }
  if (location.level === 'city') {
    hierarchy.push({ name: location.name, slug: location.slug, level: 'city' })
  }

  return hierarchy
}

const locationHierarchy = getLocationHierarchy(listing.location)
const country = locationHierarchy.find(l => l.level === 'country')

// Subscription tier system (not yet implemented)
// For SEO: Show public data in static build (website, description, certifications)
// Hide sensitive data (phone, email) - can be gated client-side later
let userTier = 'basic' // Set to 'basic' for SEO: shows website & certifications
let isLoggedIn = false
let isOwner = false

// Format custom fields by type
const formatFieldValue = (value, fieldType) => {
  if (fieldType === 'boolean') {
    return value ? 'Yes' : 'No'
  }
  if (fieldType === 'multi_select' && Array.isArray(value)) {
    return value.join(', ')
  }
  if (Array.isArray(value)) {
    return value.join(', ')
  }
  return value
}

const customFields = customFieldValues?.map(cf => ({
  name: cf.custom_field?.field_label || cf.custom_field?.field_name || 'Unknown',
  value: formatFieldValue(cf.value, cf.custom_field?.field_type),
  type: cf.custom_field?.field_type
})) || []

// Add standards as "certifications" for display
const standards = capabilities?.map(cap => ({
  name: cap.standard?.code || 'Unknown Standard',
  value: cap.standard?.name || 'Certification',
  type: 'standard'
})) || []

// Combine custom fields and standards
const allCertifications = [...customFields, ...standards]

// Tier-based visibility rules (SEO-optimized for static build)
const canViewFullAddress = true // Show location for SEO
const canViewPhone = false // Hide for privacy (can be gated client-side for owners)
const canViewEmail = false // Hide for privacy (can be gated client-side for owners)
const canViewWebsite = true // Always show (public anyway + SEO value)
const canViewCertifications = true // Always show (critical for SEO keywords)

// Show full description for SEO (critical for keyword ranking)
const descriptionPreview = listing.description || null

import { formatTitle, formatDescription } from '../../lib/seo'

// Optimized SEO parts
const locationParts = [
  listing.location?.name,
  listing.location?.parent?.name,
  listing.location?.parent?.parent?.name
].filter(Boolean);

const pageTitle = formatTitle([listing.business_name, ...locationParts]);
const pageDescription = formatDescription(
  listing.description || `${listing.business_name} is a verified testing laboratory and certification body. Access ISO 17025 accredited labs and testing services.`
);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{pageTitle}</title>
  <meta name="description" content={pageDescription}>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7003918988204966"
     crossorigin="anonymous"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
    }

    header {
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      padding: 1.5rem 2rem;
    }

    header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    header a {
      color: white;
      text-decoration: none;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    header a:hover {
      opacity: 1;
    }

    .breadcrumb {
      display: flex;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      opacity: 0.9;
    }

    .breadcrumb span {
      opacity: 0.7;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .listing-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .listing-header {
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .listing-title {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .header-badges {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .category-badge {
      display: inline-block;
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .ownership-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ownership-badge.claimed {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border: 1px solid #28a745;
    }

    .ownership-badge.pending {
      background: rgba(255, 193, 7, 0.1);
      color: #856404;
      border: 1px solid #ffc107;
    }

    .info-section {
      margin-bottom: 2rem;
    }

    .info-section h2 {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 1rem;
      border-left: 4px solid #000080;
      padding-left: 0.75rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .info-item {
      padding: 0.75rem;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 3px solid #000080;
    }

    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.85rem;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .info-value {
      color: #333;
      font-size: 1rem;
    }

    .description {
      line-height: 1.8;
      color: #555;
    }

    .custom-fields {
      background: linear-gradient(135deg, #f8f9ff 0%, #fff5f8 100%);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .custom-fields h2 {
      color: #32CD32;
      border-left-color: #32CD32;
    }

    .field-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 6px;
      border-left: 3px solid #32CD32;
    }

    .field-name {
      font-weight: 600;
      color: #555;
    }

    .field-value {
      color: #333;
      text-align: right;
    }

    .disclaimer {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%);
      border: 1px solid #ffc107;
      border-left: 4px solid #ffc107;
      border-radius: 6px;
      padding: 1rem 1.25rem;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #856404;
    }

    .disclaimer strong {
      color: #664d03;
    }

    .back-link {
      display: inline-block;
      color: #000080;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 1rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #32CD32;
    }

    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 4rem;
    }

    .upgrade-cta {
      background: linear-gradient(135deg, #f0f4ff 0%, #fff0f5 100%);
      border: 2px solid #000080;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      margin: 1rem 0;
    }

    .upgrade-cta svg {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .upgrade-cta p {
      margin: 0.5rem 0;
      color: #333;
    }

    .upgrade-cta p strong {
      color: #000080;
      font-size: 1.1rem;
    }

    .upgrade-cta p:last-child {
      font-size: 0.95rem;
      color: #666;
    }

    .upgrade-btn {
      display: inline-block;
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .upgrade-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .tier-badge {
      display: inline-block;
      background: rgba(102, 126, 234, 0.1);
      color: #000080;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 0.5rem;
    }

    .tier-badge.premium {
      background: rgba(5, 150, 105, 0.1);
      color: #32CD32;
    }

    .free-tier-preview {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%);
      padding: 0.75rem 1rem;
      border-left: 3px solid #ffc107;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .free-tier-preview::after {
      content: ' (Preview - Sign up for full details)';
      color: #856404;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .claim-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f0f4ff 0%, #fff5f8 100%);
      border: 2px solid #000080;
      border-radius: 8px;
    }

    .claim-card h3 {
      color: #000080;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }

    .claim-card p {
      color: #555;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .claim-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .claim-status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      font-weight: 500;
    }

    .claim-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .claim-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .claim-status.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .claim-status-indicator {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
    }

    .claim-status-indicator.claimed {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .claim-status-indicator.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #000080;
      border: 2px solid #000080;
    }

    .btn-secondary:hover {
      background: #f8f9ff;
    }

    .contact-hidden {
      color: #999;
      font-style: italic;
      font-size: 0.9rem;
    }

    .public-claim-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f0f4ff 0%, #fff5f8 100%);
      border: 2px solid #000080;
      border-radius: 8px;
      text-align: center;
    }

    .public-claim-section h3 {
      color: #000080;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }

    .public-claim-section p {
      color: #555;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .public-claim-section .btn {
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .public-claim-section .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    @media (max-width: 768px) {
      .listing-title {
        font-size: 1.5rem;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .field-item {
        flex-direction: column;
      }

      .field-value {
        text-align: left;
        margin-top: 0.25rem;
      }

      .upgrade-cta {
        padding: 1rem;
      }

      .upgrade-btn {
        width: 100%;
      }

      .claim-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><a href="/">TSTR Hub</a></h1>
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>‚Ä∫</span>
      <a href="/browse">Browse</a>
      {country && (
        <>
          <span>‚Ä∫</span>
          <a href={`/browse/${country.slug}`}>{country.name}</a>
        </>
      )}
      <span>‚Ä∫</span>
      <span>{listing.business_name}</span>
    </div>
  </header>

  <div class="container">
    <a href="/browse" class="back-link">‚Üê Back to Browse</a>

    <div class="listing-card">
       <div class="listing-header">
         <h1 class="listing-title">{listing.business_name}</h1>
         <div class="header-badges">
           {listing.category?.name && (
             <div class="category-badge">{listing.category.name}</div>
           )}
           <div id="ownership-badge" class="ownership-badge" style="display: none;"></div>
         </div>
       </div>

      {listing.description && (
        <div class="info-section">
          <h2>About</h2>
          <p class="description">{descriptionPreview}</p>
        </div>
      )}

      <div class="info-section">
        <h2>Contact Information {userTier !== 'free' && <span class="tier-badge">{userTier}</span>}</h2>
        <div class="info-grid">
          {listing.address && (
            <>
              {canViewFullAddress ? (
                <div class="info-item">
                  <div class="info-label">Address</div>
                  <div class="info-value">{listing.address}</div>
                </div>
              ) : (
                <div class="info-item">
                  <div class="info-label">Location</div>
                  <div class="info-value">
                    {listing.location?.name}{listing.location?.parent?.name && `, ${listing.location.parent.name}`}
                  </div>
                </div>
              )}
            </>
          )}

           {listing.phone ? (
             <div class="info-item" id="phone-item">
               <div class="info-label">Phone</div>
               <div class="info-value">
                 {canViewPhone ? (
                   <a href={`tel:${listing.phone}`}>{listing.phone}</a>
                 ) : (
                   <span class="contact-hidden">Contact info available for verified owners</span>
                 )}
               </div>
             </div>
           ) : null}

           {listing.email ? (
             <div class="info-item" id="email-item">
               <div class="info-label">Email</div>
               <div class="info-value">
                 {canViewEmail ? (
                   <a href={`mailto:${listing.email}`}>{listing.email}</a>
                 ) : (
                   <span class="contact-hidden">Contact info available for verified owners</span>
                 )}
               </div>
             </div>
           ) : null}

           {listing.website && canViewWebsite ? (
             <div class="info-item">
               <div class="info-label">Website</div>
               <div class="info-value"><a href={getRedirectUrl(listing.website, listing.id)} target="_blank" rel="noopener noreferrer" onclick="trackContactAccess('website', '{listing.website}')">{listing.website}</a></div>
             </div>
           ) : null}
        </div>
      </div>

      {allCertifications.length > 0 && (
        <div class="custom-fields">
          <h2>Certifications & Capabilities</h2>
          {allCertifications.map(field => (
            <div class="field-item">
              <div class="field-name">{field.name}</div>
              <div class="field-value">{field.value}</div>
            </div>
          ))}
        </div>
       )}

       {allCertifications.length > 0 && (
         <div class="disclaimer">
           <strong>‚ö†Ô∏è Disclaimer:</strong> Certifications and capabilities listed are extracted from public databases and have not been independently verified by TSTR.directory. We recommend verifying all credentials directly with the testing laboratory and relevant accreditation bodies before engaging services.
         </div>
       )}

        <!-- Public claim button for non-authenticated users -->
        <div id="public-claim-section" class="public-claim-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f4ff 0%, #fff5f8 100%); border: 2px solid #000080; border-radius: 8px; text-align: center;">
          <h3 style="color: #000080; margin-bottom: 0.5rem; font-size: 1.2rem;">üè¢ Is this your company?</h3>
          <p style="color: #555; margin-bottom: 1.5rem; line-height: 1.6;">Take ownership of your testing laboratory listing to manage your profile and receive direct leads.</p>
          <button id="public-claim-btn" class="btn btn-primary" style="background: linear-gradient(135deg, #000080 0%, #32CD32 100%); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
            Claim This Listing
          </button>
        </div>

        <!-- Claim listing section -->
        <div id="claim-section" class="claim-section" style="display: none;">
         <div class="claim-card">
           <h3>üè¢ Claim This Listing</h3>
           <p>Are you the owner or representative of this testing laboratory? Claim ownership to manage your listing and access additional features.</p>
           <div class="claim-actions">
             <button id="claim-btn" class="btn btn-primary">
               <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                 <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
               </svg>
               Claim This Listing
             </button>
             <button id="cancel-claim-btn" class="btn btn-secondary">Cancel</button>
           </div>
           <div id="claim-status" class="claim-status" style="display: none;"></div>
         </div>
       </div>

       <!-- Claim status indicator -->
       <div id="claim-status-indicator" class="claim-status-indicator" style="display: none;"></div>
     </div>
   </div>

   <Footer />

   <script type="module">
     import { supabaseBrowser } from '../../lib/supabase-browser'

     const listingId = '{listing.id}'
     const listingName = '{listing.business_name}'

      async function checkAuthAndClaimStatus() {
        try {
          // Check URL parameters for claim flow
          const urlParams = new URLSearchParams(window.location.search)
          const isClaimFlow = urlParams.get('claim') === 'true'

          // Check if user is authenticated
          const { data: { user }, error: authError } = await supabaseBrowser.auth.getUser()

          // Handle public claim button for non-authenticated users
          const publicClaimSection = document.getElementById('public-claim-section')
          const publicClaimBtn = document.getElementById('public-claim-btn')

          if (publicClaimBtn) {
            publicClaimBtn.addEventListener('click', () => {
              const returnUrl = `${window.location.pathname}?claim=true`
              window.location.href = `/login?redirect_to=${encodeURIComponent(returnUrl)}`
            })
          }

          if (authError || !user) {
            // User not logged in, show public claim section, hide authenticated claim section
            if (publicClaimSection) publicClaimSection.style.display = 'block'
            return
          }

          // User is authenticated, hide public claim section
          if (publicClaimSection) publicClaimSection.style.display = 'none'

         // Check if listing is already claimed
         const { data: existingClaim } = await supabaseBrowser
           .from('listing_owners')
           .select('status, verification_method')
           .eq('user_id', user.id)
           .eq('listing_id', listingId)
           .single()

         const claimSection = document.getElementById('claim-section')
         const statusIndicator = document.getElementById('claim-status-indicator')

         const ownershipBadge = document.getElementById('ownership-badge')

         if (existingClaim && existingClaim.status === 'verified') {
           // User is the verified owner - show full contact info
           isOwner = true
           showOwnerContactInfo()

           const statusInfo = getClaimStatusInfo(existingClaim.status)
           statusIndicator.innerHTML = `
             <div class="claim-status-indicator claimed">
               ${statusInfo.icon} ${statusInfo.text} - ${existingClaim.verification_method === 'domain_match' ? 'Auto-verified' : 'Manual verification'}
             </div>
           `
           statusIndicator.style.display = 'block'
           claimSection.style.display = 'none'

           // Show ownership badge
           ownershipBadge.innerHTML = `<span class="ownership-badge claimed">‚úì Verified Owner</span>`
           ownershipBadge.style.display = 'block'
         } else if (existingClaim && existingClaim.status === 'pending') {
           // User has pending claim
           const statusInfo = getClaimStatusInfo(existingClaim.status)
           statusIndicator.innerHTML = `
             <div class="claim-status-indicator pending">
               ${statusInfo.icon} ${statusInfo.text} - ${existingClaim.verification_method === 'domain_match' ? 'Auto-verified' : 'Manual verification'}
             </div>
           `
           statusIndicator.style.display = 'block'
           claimSection.style.display = 'none'

           // Show pending badge
           ownershipBadge.innerHTML = `<span class="ownership-badge pending">‚è≥ Claim Pending</span>`
           ownershipBadge.style.display = 'block'
            } else {
              // Check if listing is already claimed by someone else
              const { data: otherClaim } = await supabaseBrowser
                .from('listings')
                .select('claimed')
                .eq('id', listingId)
                .single()

              if (otherClaim?.claimed) {
                statusIndicator.innerHTML = `
                  <div class="claim-status-indicator claimed">
                    ‚úì This listing has been claimed by its owner
                  </div>
                `
                statusIndicator.style.display = 'block'
                claimSection.style.display = 'none'

                // Show claimed badge for other owners
                ownershipBadge.innerHTML = `<span class="ownership-badge claimed">‚úì Claimed</span>`
                ownershipBadge.style.display = 'block'
              } else {
                // Show claim button - always show if redirected from claim button
                claimSection.style.display = isClaimFlow ? 'block' : 'block'
              }
            }

         // Setup claim button handler
         const claimBtn = document.getElementById('claim-btn')
         const cancelBtn = document.getElementById('cancel-claim-btn')
         const claimStatus = document.getElementById('claim-status')

         claimBtn?.addEventListener('click', async () => {
           claimBtn.disabled = true
           claimBtn.innerHTML = '<span>Claiming...</span>'

           try {
             const response = await fetch('/api/claim-listing', {
               method: 'POST',
               headers: {
                 'Content-Type': 'application/json',
               },
               body: JSON.stringify({ listingId })
             })

             const result = await response.json()

             if (response.ok && result.success) {
               claimStatus.className = 'claim-status success'
               claimStatus.innerHTML = `<strong>‚úì Success!</strong> ${result.message}`
               claimStatus.style.display = 'block'

               // Hide claim section and show status
               claimSection.style.display = 'none'
               statusIndicator.innerHTML = `
                 <div class="claim-status-indicator ${result.claim.status === 'verified' ? 'claimed' : 'pending'}">
                   ‚úì ${result.claim.status === 'verified' ? 'Verified Owner' : 'Claim Pending'}
                 </div>
               `
               statusIndicator.style.display = 'block'

               // Reload page after 3 seconds to show updated state
               setTimeout(() => {
                 window.location.reload()
               }, 3000)
             } else {
               throw new Error(result.error || 'Claim failed')
             }
           } catch (error) {
             console.error('Claim error:', error)
             claimStatus.className = 'claim-status error'
             claimStatus.innerHTML = `<strong>‚úó Error:</strong> ${error.message}`
             claimStatus.style.display = 'block'
             claimBtn.disabled = false
             claimBtn.innerHTML = `
               <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                 <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
               </svg>
               Claim This Listing
             `
           }
         })

         cancelBtn?.addEventListener('click', () => {
           claimSection.style.display = 'none'
         })

       } catch (error) {
         console.error('Auth check error:', error)
       }
     }

     function getClaimStatusInfo(status) {
       switch (status) {
         case 'verified':
           return { text: 'Verified Owner', color: 'green', icon: '‚úì' }
         case 'pending':
           return { text: 'Claim Pending', color: 'yellow', icon: '‚è≥' }
         case 'rejected':
           return { text: 'Claim Rejected', color: 'red', icon: '‚úó' }
         default:
           return { text: 'Not Claimed', color: 'gray', icon: '?' }
       }
     }

      window.trackContactAccess = async function(contactType, contactValue) {
        try {
          // Only track if listing is claimed (leads only matter for claimed listings)
          const response = await fetch('/api/leads/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              listingId: '{listing.id}',
              contactType: contactType,
              contactValue: contactValue
            })
          })

          // We don't need to wait for the response or show errors to users
          // Lead tracking should be invisible to maintain good UX
          if (!response.ok) {
            console.warn('Failed to track contact access:', await response.text())
          }
        } catch (error) {
          // Silently fail - don't disrupt user experience
          console.warn('Lead tracking error:', error)
        }
      }

      function showOwnerContactInfo() {
        // Show phone number if available
        const phoneItem = document.getElementById('phone-item')
        if (phoneItem && '{listing.phone}') {
          const valueDiv = phoneItem.querySelector('.info-value')
          if (valueDiv) {
            const phoneLink = document.createElement('a')
            phoneLink.href = `tel:{listing.phone}`
            phoneLink.textContent = '{listing.phone}'
            phoneLink.addEventListener('click', () => trackContactAccess('phone', '{listing.phone}'))
            valueDiv.innerHTML = ''
            valueDiv.appendChild(phoneLink)
          }
        }

        // Show email if available
        const emailItem = document.getElementById('email-item')
        if (emailItem && '{listing.email}') {
          const valueDiv = emailItem.querySelector('.info-value')
          if (valueDiv) {
            const emailLink = document.createElement('a')
            emailLink.href = `mailto:{listing.email}`
            emailLink.textContent = '{listing.email}'
            emailLink.addEventListener('click', () => trackContactAccess('email', '{listing.email}'))
            valueDiv.innerHTML = ''
            valueDiv.appendChild(emailLink)
          }
        }
      }

     // Initialize when page loads
     document.addEventListener('DOMContentLoaded', checkAuthAndClaimStatus)

     // Also check when auth state changes
     supabaseBrowser.auth.onAuthStateChange((event, session) => {
       if (event === 'SIGNED_IN' && session) {
         checkAuthAndClaimStatus()
       }
     })
   </script>
 </body>
</html>
