---
import { supabase } from '../../lib/supabase'

// Force SSR - we need to check user session/tier dynamically
export const prerender = false

const { slug } = Astro.params

// Fetch listing with location hierarchy and custom fields
const { data: listing, error } = await supabase
  .from('listings')
  .select(`
    *,
    category:category_id (
      id,
      name,
      slug
    ),
    location:location_id (
      id,
      name,
      slug,
      level,
      parent:parent_id (
        id,
        name,
        slug,
        level,
        parent:parent_id (
          id,
          name,
          slug,
          level
        )
      )
    )
  `)
  .eq('slug', slug)
  .eq('status', 'active')
  .single()

if (error || !listing) {
  return Astro.redirect('/browse')
}

// Fetch custom field values
const { data: customFieldValues, error: cfError } = await supabase
  .from('listing_custom_fields')
  .select(`
    value,
    custom_field:custom_field_id (
      field_name,
      field_type,
      field_label,
      options
    )
  `)
  .eq('listing_id', listing.id)

// Build location breadcrumb
const getLocationHierarchy = (location) => {
  if (!location) return []
  const hierarchy = []

  if (location.parent?.parent?.level === 'country') {
    hierarchy.push({ name: location.parent.parent.name, slug: location.parent.parent.slug, level: 'country' })
  }
  if (location.parent?.level === 'state') {
    hierarchy.push({ name: location.parent.name, slug: location.parent.slug, level: 'state' })
  }
  if (location.level === 'city') {
    hierarchy.push({ name: location.name, slug: location.slug, level: 'city' })
  }

  return hierarchy
}

const locationHierarchy = getLocationHierarchy(listing.location)
const country = locationHierarchy.find(l => l.level === 'country')

// Get user session and subscription tier
const authHeader = Astro.request.headers.get('cookie')
let userTier = 'free'
let isLoggedIn = false

if (authHeader) {
  try {
    // Fetch user from the browser's authenticated session
    const sessionResponse = await fetch('https://haimjeaetrsaauitrhfy.supabase.co/auth/v1/user', {
      headers: {
        'Authorization': `Bearer ${authHeader.split('sb-access-token=')[1]?.split(';')[0] || ''}`,
        'Content-Type': 'application/json'
      }
    })

    if (sessionResponse.ok) {
      const userData = await sessionResponse.json()
      if (userData.id) {
        isLoggedIn = true

        // Fetch user profile with subscription tier
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('subscription_tier')
          .eq('id', userData.id)
          .single()

        userTier = profile?.subscription_tier || 'basic'
      }
    }
  } catch (e) {
    // Silently fail - user will be treated as free tier
    userTier = 'free'
  }
}

// Format custom fields by type
const formatFieldValue = (value, fieldType) => {
  if (fieldType === 'boolean') {
    return value ? 'Yes' : 'No'
  }
  if (fieldType === 'multi_select' && Array.isArray(value)) {
    return value.join(', ')
  }
  if (Array.isArray(value)) {
    return value.join(', ')
  }
  return value
}

const customFields = customFieldValues?.map(cf => ({
  name: cf.custom_field?.field_label || cf.custom_field?.field_name || 'Unknown',
  value: formatFieldValue(cf.value, cf.custom_field?.field_type),
  type: cf.custom_field?.field_type
})) || []

// Tier-based visibility rules
const canViewFullAddress = userTier !== 'free'
const canViewPhone = userTier === 'professional' || userTier === 'premium' || userTier === 'enterprise'
const canViewEmail = userTier === 'professional' || userTier === 'premium' || userTier === 'enterprise'
const canViewWebsite = userTier !== 'free'
const canViewCertifications = userTier !== 'free'

// Get description preview for free tier (150 chars)
const descriptionPreview = listing.description
  ? userTier === 'free'
    ? listing.description.substring(0, 150) + (listing.description.length > 150 ? '...' : '')
    : listing.description
  : null

// Count certifications (visible to free tier as count only)
const certificationCount = customFields.length
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{listing.business_name} | TSTR Hub</title>
  <meta name="description" content={listing.description}>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7003918988204966"
     crossorigin="anonymous"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem 2rem;
    }

    header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    header a {
      color: white;
      text-decoration: none;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    header a:hover {
      opacity: 1;
    }

    .breadcrumb {
      display: flex;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      opacity: 0.9;
    }

    .breadcrumb span {
      opacity: 0.7;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .listing-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .listing-header {
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .listing-title {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .category-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .info-section {
      margin-bottom: 2rem;
    }

    .info-section h2 {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 1rem;
      border-left: 4px solid #667eea;
      padding-left: 0.75rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .info-item {
      padding: 0.75rem;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }

    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.85rem;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .info-value {
      color: #333;
      font-size: 1rem;
    }

    .description {
      line-height: 1.8;
      color: #555;
    }

    .custom-fields {
      background: linear-gradient(135deg, #f8f9ff 0%, #fff5f8 100%);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .custom-fields h2 {
      color: #764ba2;
      border-left-color: #764ba2;
    }

    .field-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 6px;
      border-left: 3px solid #764ba2;
    }

    .field-name {
      font-weight: 600;
      color: #555;
    }

    .field-value {
      color: #333;
      text-align: right;
    }

    .disclaimer {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%);
      border: 1px solid #ffc107;
      border-left: 4px solid #ffc107;
      border-radius: 6px;
      padding: 1rem 1.25rem;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #856404;
    }

    .disclaimer strong {
      color: #664d03;
    }

    .back-link {
      display: inline-block;
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 1rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #764ba2;
    }

    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 4rem;
    }

    .upgrade-cta {
      background: linear-gradient(135deg, #f0f4ff 0%, #fff0f5 100%);
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      margin: 1rem 0;
    }

    .upgrade-cta svg {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .upgrade-cta p {
      margin: 0.5rem 0;
      color: #333;
    }

    .upgrade-cta p strong {
      color: #667eea;
      font-size: 1.1rem;
    }

    .upgrade-cta p:last-child {
      font-size: 0.95rem;
      color: #666;
    }

    .upgrade-btn {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      margin-top: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .upgrade-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .tier-badge {
      display: inline-block;
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 0.5rem;
    }

    .tier-badge.premium {
      background: rgba(118, 75, 162, 0.1);
      color: #764ba2;
    }

    .free-tier-preview {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%);
      padding: 0.75rem 1rem;
      border-left: 3px solid #ffc107;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .free-tier-preview::after {
      content: ' (Preview - Sign up for full details)';
      color: #856404;
      font-size: 0.85rem;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .listing-title {
        font-size: 1.5rem;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .field-item {
        flex-direction: column;
      }

      .field-value {
        text-align: left;
        margin-top: 0.25rem;
      }

      .upgrade-cta {
        padding: 1rem;
      }

      .upgrade-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><a href="/">TSTR Hub</a></h1>
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>‚Ä∫</span>
      <a href="/browse">Browse</a>
      {country && (
        <>
          <span>‚Ä∫</span>
          <a href={`/browse/${country.slug}`}>{country.name}</a>
        </>
      )}
      <span>‚Ä∫</span>
      <span>{listing.business_name}</span>
    </div>
  </header>

  <div class="container">
    <a href="/browse" class="back-link">‚Üê Back to Browse</a>

    <div class="listing-card">
      <div class="listing-header">
        <h1 class="listing-title">{listing.business_name}</h1>
        {listing.category?.name && (
          <div class="category-badge">{listing.category.name}</div>
        )}
      </div>

      {listing.description && (
        <div class="info-section">
          <h2>About</h2>
          {userTier === 'free' && (
            <div class="free-tier-preview"></div>
          )}
          <p class="description">{descriptionPreview}</p>
        </div>
      )}

      <div class="info-section">
        <h2>Contact Information {userTier !== 'free' && <span class="tier-badge">{userTier}</span>}</h2>
        <div class="info-grid">
          {listing.address && (
            <>
              {canViewFullAddress ? (
                <div class="info-item">
                  <div class="info-label">Address</div>
                  <div class="info-value">{listing.address}</div>
                </div>
              ) : (
                <div class="info-item">
                  <div class="info-label">Location</div>
                  <div class="info-value">
                    {listing.location?.name}{listing.location?.parent?.name && `, ${listing.location.parent.name}`}
                  </div>
                </div>
              )}
            </>
          )}

          {listing.phone && canViewPhone ? (
            <div class="info-item">
              <div class="info-label">Phone</div>
              <div class="info-value"><a href={`tel:${listing.phone}`}>{listing.phone}</a></div>
            </div>
          ) : null}

          {listing.email && canViewEmail ? (
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value"><a href={`mailto:${listing.email}`}>{listing.email}</a></div>
            </div>
          ) : null}

          {listing.website && canViewWebsite ? (
            <div class="info-item">
              <div class="info-label">Website</div>
              <div class="info-value"><a href={listing.website} target="_blank" rel="noopener noreferrer">{listing.website}</a></div>
            </div>
          ) : null}
        </div>

        {userTier === 'free' && (
          <div class="upgrade-cta">
            <svg>üîí</svg>
            <p><strong>Contact information hidden</strong></p>
            <p>Sign up free to view full listing details</p>
            <a href="/signup" class="upgrade-btn">Sign Up Free</a>
          </div>
        )}

        {userTier === 'basic' && (
          <div class="upgrade-cta">
            <svg>üìû</svg>
            <p><strong>Contact details available for Professional tier</strong></p>
            <p>Upgrade to Professional ($295/mo) to view phone and email</p>
            <a href="/account/subscription" class="upgrade-btn">View Plans</a>
          </div>
        )}
      </div>

      {customFields.length > 0 && (
        <div class="custom-fields">
          <h2>Certifications & Capabilities {canViewCertifications && <span class="tier-badge premium">{userTier}</span>}</h2>

          {canViewCertifications ? (
            <>
              {customFields.map(field => (
                <div class="field-item">
                  <div class="field-name">{field.name}</div>
                  <div class="field-value">{field.value}</div>
                </div>
              ))}
            </>
          ) : (
            <>
              <div class="field-item">
                <div class="field-name">Total Certifications Found</div>
                <div class="field-value">{certificationCount}</div>
              </div>
              <div class="upgrade-cta">
                <svg>üîê</svg>
                <p><strong>Certification details hidden</strong></p>
                <p>Sign up free to view full certification list</p>
                <a href="/signup" class="upgrade-btn">Sign Up Free</a>
              </div>
            </>
          )}
        </div>
      )}

      {customFields.length > 0 && (
        <div class="disclaimer">
          <strong>‚ö†Ô∏è Disclaimer:</strong> Certifications and capabilities listed are extracted from public databases and have not been independently verified by TSTR.site. We recommend verifying all credentials directly with the testing laboratory and relevant accreditation bodies before engaging services.
        </div>
      )}
    </div>
  </div>

  <Footer />
</body>
</html>
