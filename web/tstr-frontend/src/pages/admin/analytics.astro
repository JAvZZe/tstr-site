---
import AdminLayout from '../../layouts/AdminLayout.astro';

// Force SSR shell
export const prerender = false;
---

<AdminLayout title="Analytics Dashboard">
    <div id="loading" class="flex items-center justify-center min-h-[50vh]">
        <div class="text-center">
             <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-500 text-lg">Loading Analytics...</p>
        </div>
    </div>

    <div id="content" class="hidden space-y-8">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
             <button id="refresh-btn" class="text-sm text-blue-600 hover:text-blue-800">Refresh Data</button>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
             <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm font-medium uppercase">Total Clicks</h3>
                <p class="text-3xl font-bold text-blue-600 mt-2" id="stat-total">-</p>
                <p class="text-xs text-gray-400 mt-1">All time</p>
             </div>
             <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm font-medium uppercase">Last 30 Days</h3>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="stat-30d">-</p>
                <p class="text-xs text-gray-400 mt-1" id="stat-30d-pct"></p>
             </div>
             <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm font-medium uppercase">Last 7 Days</h3>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="stat-7d">-</p>
                <p class="text-xs text-gray-400 mt-1" id="stat-7d-pct"></p>
             </div>
             <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm font-medium uppercase">Avg Per Day</h3>
                <p class="text-3xl font-bold text-gray-900 mt-2" id="stat-avg">-</p>
                <p class="text-xs text-gray-400 mt-1">Last 30 days</p>
             </div>
        </div>

        <!-- Chart -->
        <div class="bg-white rounded-lg shadow-md p-6" id="chart-section">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Click Trends (Last 30 Days)</h2>
            <div id="chart-container" class="h-48 flex items-end gap-1 pb-4">
                <!-- Bars injected here -->
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
             <!-- Top Listings -->
             <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">üèÜ Top Performing Listings</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Listing</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clicks</th>
                            </tr>
                        </thead>
                        <tbody id="top-listings-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
             </div>

             <!-- Recent Activity -->
             <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">üïê Recent Click Activity</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Listing</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            </tr>
                        </thead>
                        <tbody id="recent-clicks-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
             </div>
        </div>
    </div>
</AdminLayout>

<script>
    import { supabaseBrowser } from '../../lib/supabase-browser';

    async function loadAnalytics() {
        const loading = document.getElementById('loading');
        const content = document.getElementById('content');
        
        try {
            // 1. Auth Check
            const { data: { session } } = await supabaseBrowser.auth.getSession();
            if (!session) {
                window.location.href = '/admin/login';
                return;
            }

            // 2. Fetch Data
            const res = await fetch('/api/admin/analytics', {
                headers: { 'Authorization': `Bearer ${session.access_token}` }
            });

            if (!res.ok) throw new Error('Failed to load analytics');

            const data = await res.json();
            const { metrics, recentClicks, topListings, chartData } = data;

            // 3. Render Metrics
            document.getElementById('stat-total').textContent = metrics.totalClicks;
            document.getElementById('stat-30d').textContent = metrics.clicks30d;
            document.getElementById('stat-7d').textContent = metrics.clicks7d;
            document.getElementById('stat-avg').textContent = metrics.avgPerDay;

            const pct30 = metrics.totalClicks ? Math.round((metrics.clicks30d / metrics.totalClicks) * 100) : 0;
            document.getElementById('stat-30d-pct').textContent = `${pct30}% of total`;
            
            const pct7 = metrics.clicks30d ? Math.round((metrics.clicks7d / metrics.clicks30d) * 100) : 0;
             document.getElementById('stat-7d-pct').textContent = `${pct7}% of last 30d`;

            // 4. Render Chart
            const chartContainer = document.getElementById('chart-container');
            if (chartData && chartData.length > 0) {
                const maxCount = Math.max(...chartData.map(d => d.count), 1);
                chartContainer.innerHTML = chartData.map(d => `
                    <div class="flex-1 bg-blue-500 hover:bg-blue-600 rounded-t relative group transition-all" 
                         style="height: ${(d.count / maxCount) * 100}%"
                         title="${d.date}: ${d.count}">
                         <div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 text-xs font-bold text-blue-600 hidden group-hover:block whitespace-nowrap bg-white px-1 shadow rounded">
                            ${d.count}
                         </div>
                    </div>
                `).join('');
            } else {
                chartContainer.innerHTML = '<p class="text-gray-400 w-full text-center self-center">No trend data available</p>';
            }

            // 5. Render Tables
            const topTable = document.getElementById('top-listings-table');
            if (!topListings || topListings.length === 0) {
                topTable.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No data</td></tr>';
            } else {
                 topTable.innerHTML = topListings.map((l, i) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-bold text-gray-500">#${i + 1}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${l.listing?.business_name || l.business_name || 'Unknown'}</div>
                            <div class="text-xs text-gray-500">${l.listing?.category?.name || l.category_name || ''}</div>
                        </td>
                         <td class="px-6 py-4">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">${l.count || l.clicks}</span>
                        </td>
                    </tr>
                 `).join('');
            }

            const recentTable = document.getElementById('recent-clicks-table');
            if (!recentClicks || recentClicks.length === 0) {
                recentTable.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-center text-gray-500">No recent clicks</td></tr>';
            } else {
                recentTable.innerHTML = recentClicks.map(c => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${c.listings?.business_name || 'Unknown'}</div>
                            <div class="text-xs text-gray-500 truncate max-w-[150px]">${c.url}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            ${new Date(c.created_at).toLocaleString()}
                        </td>
                    </tr>
                `).join('');
            }

            loading.classList.add('hidden');
            content.classList.remove('hidden');

        } catch (e) {
            console.error(e);
            loading.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
        }
    }

    document.getElementById('refresh-btn')?.addEventListener('click', loadAnalytics);
    
    // Init
    loadAnalytics();
</script>
