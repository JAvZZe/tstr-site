---
export const prerender = false // Force SSR for auth page

import { supabaseBrowser } from '../../lib/supabase-browser'
import Footer from '../../components/Footer.astro'
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Login - TSTR Administration</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    header h1 a {
      color: white;
      text-decoration: none;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .subtitle {
      color: #a0a0a0;
      font-size: 0.9rem;
      margin-left: 0.5rem;
      font-weight: 400;
    }

    .container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .login-card {
      background: white;
      border-radius: 8px;
      padding: 2.5rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 100%;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h2 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .login-header p {
      color: #666;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-weight: 600;
      color: #444;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #1a1a2e;
      box-shadow: 0 0 0 2px rgba(26, 26, 46, 0.1);
    }

    .btn {
      width: 100%;
      background: #1a1a2e;
      color: white;
      padding: 0.875rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #2a2a4ed0;
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .message {
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      text-align: center;
    }

    .message.error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
    }

    .message.success {
      background: #efe;
      border: 1px solid #cfc;
      color: #3c3;
    }

    footer {
      color: rgba(255, 255, 255, 0.4);
      text-align: center;
      padding: 1.5rem;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <a href="/">TSTR Hub</a>
      <span class="subtitle">Administration</span>
    </h1>
  </header>

  <div class="container">
    <div class="login-card">
      <div class="login-header">
        <h2>Staff Login</h2>
        <p>Authorized personnel only</p>
      </div>

      <div id="message-container"></div>

      <form id="login-form">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required autocomplete="email" placeholder="name@tstr.directory">
        </div>

        <div class="form-group relative">
          <label for="password">Password</label>
          <div class="relative">
            <input type="password" id="password" name="password" required autocomplete="current-password" class="pr-10">
            <button type="button" id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Toggle password visibility">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
        </div>

        <button type="submit" class="btn" id="submit-btn">Authenticate</button>
      </form>
    </div>
  </div>

  <footer>
    &copy; {new Date().getFullYear()} TSTR Directory. Internal System.
  </footer>

  <script>
    import { supabaseBrowser } from '../../lib/supabase-browser'
    
    document.addEventListener('DOMContentLoaded', () => {

    const form = document.getElementById('login-form')
    const submitBtn = document.getElementById('submit-btn')
    const messageContainer = document.getElementById('message-container')

    function showMessage(message, type = 'info') {
      messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`
    }

    // Check for session
    async function checkSession() {
      const { data: { session } } = await supabaseBrowser.auth.getSession()
      if (session) {
        const role = session.user?.user_metadata?.role;
        if (role === 'staff' || role === 'super_admin') {
          window.location.href = '/admin/dashboard'
        } else {
             await supabaseBrowser.auth.signOut()
        }
      }
    }
    
    checkSession();

    form?.addEventListener('submit', async (e) => {
      e.preventDefault()

      const email = document.getElementById('email').value.trim()
      const password = document.getElementById('password').value.trim()

      submitBtn.disabled = true
      submitBtn.textContent = 'Authenticating...'

      try {
        // Authenticate via Server API (Bypasses Captcha)
        const response = await fetch('/api/admin/auth-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const result = await response.json();

        if (!response.ok) {
           showMessage(result.error || 'Authentication failed', 'error');
           submitBtn.disabled = false;
           submitBtn.textContent = 'Authenticate';
           return;
        }

        // Set Session Client-Side
        if (result.session) {
           const { error: sessionError } = await supabaseBrowser.auth.setSession(result.session);
           
           if (sessionError) {
             showMessage('Network error setting session. Please retry.', 'error');
             console.error(sessionError);
             submitBtn.disabled = false;
             submitBtn.textContent = 'Authenticate';
             return;
           }
           
           showMessage('Access granted. Redirecting...', 'success');
           setTimeout(() => {
              window.location.href = '/admin/dashboard';
           }, 800);
        }

      } catch (err) {
        showMessage('An unexpected error occurred.', 'error')
        submitBtn.disabled = false
        submitBtn.textContent = 'Authenticate'
        console.error('Login error:', err)
      }
    })
    // Toggle Password Visibility
    const toggleBtn = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    
    toggleBtn?.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Update Icon (Simple slash toggle)
        if (type === 'text') {
            toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.059 10.059 0 013.949-5.347m1.789.894A3.376 3.376 0 0112 7.5a3.375 3.375 0 013.375 3.375c0 .644-.225 1.233-.604 1.706l-6.146-6.146zm12.353 12.353l-6.146-6.146a3.37 3.37 0 00-.947-2.287l6.146 6.146zM2 2l20 20" /></svg>`;
        } else {
            toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
        }
    });

    });

  </script>
</body>
</html>
