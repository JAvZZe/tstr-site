---
import { supabase } from '../../lib/supabase'

// Force SSR for dynamic data
export const prerender = false;

// Auth Check
const { data: { session } } = await supabase.auth.getSession();
if (!session || !session.user.email?.endsWith('@tstr.directory')) {
  return Astro.redirect('/admin/login');
}

// Fetch all claims
const { data: claims, error: claimsError } = await supabase
  .from('claims')
  .select('id, provider_name, contact_name, business_email, phone, created_at, status')
  .order('created_at', { ascending: false })

const title = 'Claims Management'
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>function initApollo(){var n=Math.random().toString(36).substring(7),o=document.createElement("script");
  o.src="https://assets.apollo.io/micro/website-tracker/tracker.iife.js?nocache="+n,o.async=!0,o.defer=!0,
  o.onload=function(){window.trackingFunctions.onLoad({appId:"6979e8021ac917001927e9b2"})},
  document.head.appendChild(o)}initApollo();</script>
</head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <div class="mb-6">
        <a href="/admin" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Admin Dashboard</a>
      </div>

      <h1 class="text-3xl font-bold text-gray-900 mb-8">{title}</h1>

      {claimsError && (
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <p class="text-red-800">Error loading claims: {claimsError.message}</p>
        </div>
      )}

      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-800">All Claims ({claims?.length || 0})</h2>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provider</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {claims?.map((claim) => (
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">{claim.provider_name}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{claim.contact_name}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{claim.business_email}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-500">{claim.phone || 'N/A'}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                      claim.status === 'approved' ? 'bg-green-100 text-green-800' :
                      claim.status === 'rejected' ? 'bg-red-100 text-red-800' :
                      'bg-yellow-100 text-yellow-800'
                    }`}>
                      {claim.status || 'pending'}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {new Date(claim.created_at).toLocaleDateString()}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                      {(!claim.status || claim.status === 'pending') && (
                        <>
                          <button
                            class="text-green-600 hover:text-green-900 approve-btn"
                            data-id={claim.id}
                          >
                            Approve
                          </button>
                          <button
                            class="text-red-600 hover:text-red-900 reject-btn"
                            data-id={claim.id}
                          >
                            Reject
                          </button>
                        </>
                      )}
                      {claim.status === 'approved' && (
                        <span class="text-green-600">Approved</span>
                      )}
                      {claim.status === 'rejected' && (
                        <span class="text-red-600">Rejected</span>
                      )}
                    </div>
                  </td>
                </tr>
              )) || (
                <tr>
                  <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                    No claims found
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      async function updateClaimStatus(claimId, status) {
        if (confirm(`Are you sure you want to ${status} this claim?`)) {
          try {
            const response = await fetch('/api/claim-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: claimId, status: status })
            });
            if (response.ok) {
              location.reload();
            } else {
              const error = await response.json();
              alert('Error updating claim status: ' + (error.error || response.statusText));
            }
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      }

      // Bind dynamic listeners
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            updateClaimStatus(id, 'approved');
          });
        });

        document.querySelectorAll('.reject-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            updateClaimStatus(id, 'rejected');
          });
        });
      });
    </script>
  </body>
</html>