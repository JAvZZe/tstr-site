---
import { supabase } from '../lib/supabase'
import { CONTENT, CONTACTS, MAILTO_LINKS } from '../lib/contacts'
import Footer from '../components/Footer.astro'
import { getRedirectUrl } from '../lib/redirect'
import BaseLayout from '../layouts/BaseLayout.astro'

// Fetch all active listings with location hierarchy, category, and capabilities
const { data: listings, error } = await supabase
  .from('listings')
  .select(`
    *,
    category:category_id (
      id,
      name,
      slug
    ),
    location:location_id (
      id,
      name,
      slug,
      level,
      parent:parent_id (
        id,
        name,
        slug,
        level,
        parent:parent_id (
          id,
          name,
          slug,
          level
        )
      )
    ),
    listing_capabilities(
      standard:standard_id(
        id,
        code,
        name,
        issuing_body,
        standard_type
      )
    )
  `)
  .eq('status', 'active')
  .order('created_at', { ascending: false })

// Fetch categories with active listings only for filter dropdown
const { data: categoriesData } = await supabase
  .from('categories')
  .select(`
    id,
    name,
    slug,
    listings:listings!category_id(count)
  `)
  .order('name', { ascending: true })

// Filter to only categories with active listings
const allCategories = (categoriesData || [])
  .filter(cat => cat.listings && cat.listings[0]?.count > 0)
  .map(cat => ({ id: cat.id, name: cat.name, slug: cat.slug }))

// Fetch all active standards for filter dropdown
const { data: standardsData } = await supabase
  .from('standards')
  .select(`
    id,
    code,
    name,
    issuing_body,
    standard_type,
    category_id
  `)
  .eq('is_active', true)
  .order('issuing_body', { ascending: true })
  .order('code', { ascending: true })

// Extract unique standards from listings capabilities
const standardsMap = new Map()
listings?.forEach(listing => {
  if (listing.listing_capabilities) {
    listing.listing_capabilities.forEach(capability => {
      if (capability.standard) {
        const standard = capability.standard
        const key = `${standard.code} - ${standard.name}`
        if (!standardsMap.has(key)) {
          standardsMap.set(key, {
            id: standard.id,
            code: standard.code,
            name: standard.name,
            issuing_body: standard.issuing_body,
            standard_type: standard.standard_type,
            displayName: `${standard.code} - ${standard.name}`
          })
        }
      }
    })
  }
})

const allStandards = Array.from(standardsMap.values()).sort((a, b) => {
  // Sort by issuing body first, then by code
  const bodyCompare = (a.issuing_body || '').localeCompare(b.issuing_body || '')
  if (bodyCompare !== 0) return bodyCompare
  return a.code.localeCompare(b.code)
})

// Extract unique countries and cities from location hierarchy and address
const getCountryFromLocation = (location) => {
  if (!location) return null
  if (location.level === 'country') return { name: location.name, slug: location.name.toLowerCase().replace(/\s+/g, '-') }
  if (location.parent?.level === 'country') return { name: location.parent.name, slug: location.parent.name.toLowerCase().replace(/\s+/g, '-') }
  if (location.parent?.parent?.level === 'country') return { name: location.parent.parent.name, slug: location.parent.parent.name.toLowerCase().replace(/\s+/g, '-') }
  return null
}

const getCityFromLocation = (location) => {
  if (!location) return null
  if (location.level === 'city') return { name: location.name, slug: location.name.toLowerCase().replace(/\s+/g, '-') }
  return null
}

const extractCountry = (address) => {
  if (!address) return ''
  const parts = address.split(',').map(p => p.trim())
  return parts[parts.length - 1] || ''
}

const extractCity = (address) => {
  if (!address) return ''
  const parts = address.split(',').map(p => p.trim())
  return parts[0] || ''
}

// Known countries list for validation
const knownCountries = new Set([
  'United States', 'Canada', 'United Kingdom', 'Germany', 'Netherlands',
  'Singapore', 'Thailand', 'Kuwait', 'UAE', 'UK', 'USA'
])

const countryMap = new Map()
const cityMap = new Map()

listings?.forEach(listing => {
  // From location hierarchy
  const country = getCountryFromLocation(listing.location)
  if (country) countryMap.set(country.slug, country.name)

  const city = getCityFromLocation(listing.location)
  if (city) cityMap.set(city.slug, city.name)

  // From address field as fallback - only if it looks like a real country/city
  const addressCountry = extractCountry(listing.address)
  if (addressCountry && knownCountries.has(addressCountry) && !countryMap.has(addressCountry.toLowerCase().replace(/\s+/g, '-'))) {
    countryMap.set(addressCountry.toLowerCase().replace(/\s+/g, '-'), addressCountry)
  }

  const addressCity = extractCity(listing.address)
  // Only add if it doesn't look like a street address (no numbers, reasonable length)
  if (addressCity &&
      !/\d/.test(addressCity) &&
      addressCity.length > 2 &&
      addressCity.length < 30 &&
      !cityMap.has(addressCity.toLowerCase().replace(/\s+/g, '-'))) {
    cityMap.set(addressCity.toLowerCase().replace(/\s+/g, '-'), addressCity)
  }
})

// Create combined location options for fuzzy search
const locationOptions = []
countryMap.forEach((name, slug) => {
  locationOptions.push({ name, type: 'country', displayName: `${name} (Country)` })
})
cityMap.forEach((name, slug) => {
  locationOptions.push({ name, type: 'city', displayName: `${name} (City)` })
})

const totalListings = listings?.length || 0

// Get category from URL parameter for dynamic heading
const urlParams = new URLSearchParams(Astro.url.search)
const categoryParam = urlParams.get('category')
const getCategoryDisplayName = (categorySlug) => {
  if (!categorySlug) return null
  return categorySlug.replace(/%20/g, ' ')
}
const categoryDisplayName = getCategoryDisplayName(categoryParam)

// Helper functions for filtering are defined in the frontmatter
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{categoryDisplayName ? `${categoryDisplayName} | TSTR Hub` : 'Browse Testing Laboratories | TSTR Hub'}</title>
  <meta name="description" content="Browse {totalListings} verified testing service providers by country, city, and specialty. Oil & Gas, Pharmaceutical, Environmental testing labs worldwide.">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7003918988204966"
     crossorigin="anonymous"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
    }

    header {
      background: linear-gradient(135deg, #2563EB 0%, #059669 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .breadcrumb {
      margin-top: 1rem;
      opacity: 0.9;
    }

    .breadcrumb a {
      color: white;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    .filters {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      color: #2563EB;
      margin-bottom: 0.5rem;
    }

    .filter-group select {
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .filter-group select:focus {
      outline: none;
      border-color: #2563EB;
    }

    .results-count {
      background: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      text-align: center;
      font-weight: 600;
      color: #2563EB;
    }

    .listings-grid {
      display: grid;
      gap: 1.5rem;
    }

    .listing-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 2rem;
      transition: all 0.3s ease;
    }

    .listing-card:hover {
      border-color: #2563EB;
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
      transform: translateY(-2px);
    }

    .listing-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .listing-title {
      color: #2563EB;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .listing-title a {
      color: #2563EB;
      text-decoration: none;
      transition: color 0.2s;
    }

    .listing-title a:hover {
      color: #059669;
    }

    .category-badge {
      background: #f0f0f0;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      color: #555;
      display: inline-block;
    }

    .verified-badge {
      background: #4caf50;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .listing-description {
      color: #666;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .listing-details {
      display: grid;
      gap: 0.5rem;
      color: #555;
      font-size: 0.95rem;
    }

    .listing-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      align-items: center;
    }

    .visit-btn {
      background: #2563EB;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .visit-btn:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(102,126,234,0.3);
    }

    .claim-link {
      color: #2563EB;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid transparent;
      transition: all 0.3s ease;
    }

    .claim-link:hover {
      color: #059669;
      border-bottom-color: #059669;
    }

    .detail-item {
      display: flex;
      gap: 0.5rem;
    }

    .detail-icon {
      color: #2563EB;
      font-weight: 600;
    }

    .detail-item a {
      color: #2563EB;
      text-decoration: none;
    }

    .detail-item a:hover {
      text-decoration: underline;
    }

    .no-results {
      background: white;
      padding: 3rem;
      border-radius: 12px;
      text-align: center;
      color: #666;
    }

    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 3rem;
    }

    footer a {
      color: white;
      text-decoration: none;
      margin: 0 1rem;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }

    /* Autocomplete Dropdown Styles */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-input {
      width: 100%;
      padding: 0.75rem 2.5rem 0.75rem 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
      cursor: text;
      transition: border-color 0.2s ease;
    }

    .autocomplete-input:focus {
      outline: none;
      border-color: #2563EB;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .autocomplete-input::placeholder {
      color: #a0aec0;
    }

    .autocomplete-clear {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #a0aec0;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      font-size: 1.2rem;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.2s ease, color 0.2s ease;
    }

    .autocomplete-clear:hover {
      color: #4a5568;
      background: #f7fafc;
    }

    .autocomplete-clear.visible {
      opacity: 1;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e2e8f0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-option {
      padding: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border-bottom: 1px solid #f7fafc;
    }

    .autocomplete-option:last-child {
      border-bottom: none;
    }

    .autocomplete-option:hover,
    .autocomplete-option.selected {
      background-color: #f7fafc;
    }

    .autocomplete-option.highlighted {
      background-color: #edf2f7;
    }

    .autocomplete-no-results {
      padding: 0.75rem;
      color: #a0aec0;
      font-style: italic;
    }

    .autocomplete-match {
      font-weight: 600;
      color: #2563EB;
    }

    .certification-disclaimer {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%);
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .disclaimer-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-top: 0.25rem;
    }

    .disclaimer-content {
      flex: 1;
    }

    .disclaimer-content p {
      margin: 0;
      font-size: 0.95rem;
      color: #333;
      line-height: 1.5;
    }

    @media (max-width: 768px) {
      .certification-disclaimer {
        flex-direction: column;
        gap: 0.75rem;
      }

      .disclaimer-icon {
        margin-top: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>{categoryDisplayName ? `Browse ${categoryDisplayName}` : 'Browse Testing Laboratories'}</h1>
    <p class="breadcrumb">
      <a href="/">Home</a> / {categoryDisplayName ? `${categoryDisplayName} | ` : ''}Browse All Listings | <a href="/search/standards">üî¨ Search by Standard</a>
    </p>
  </header>

  <main>
    <div class="filters">
      <div class="filter-group">
        <label for="location-filter">Location</label>
        <div class="autocomplete-container">
          <input
            type="text"
            id="location-filter"
            class="autocomplete-input"
            placeholder="Type to search cities or countries..."
            autocomplete="off"
            role="combobox"
            aria-expanded="false"
            aria-autocomplete="list"
            aria-label="Location"
          >
          <button type="button" class="autocomplete-clear" aria-label="Clear selection">√ó</button>
          <div class="autocomplete-dropdown hidden" role="listbox"></div>
        </div>
      </div>

      <div class="filter-group">
        <label for="category-filter">Category</label>
        <div class="autocomplete-container">
          <input 
            type="text" 
            id="category-filter" 
            class="autocomplete-input" 
            placeholder="Type to search categories..."
            autocomplete="off"
            role="combobox"
            aria-expanded="false"
            aria-autocomplete="list"
            aria-label="Category"
          >
          <button type="button" class="autocomplete-clear" aria-label="Clear selection">√ó</button>
          <div class="autocomplete-dropdown hidden" role="listbox"></div>
        </div>
      </div>

      <div class="filter-group">
        <label for="standard-filter">Standard or Certification</label>
        <div class="autocomplete-container">
          <input 
            type="text" 
            id="standard-filter" 
            class="autocomplete-input" 
            placeholder="Type to search standards..."
            autocomplete="off"
            role="combobox"
            aria-expanded="false"
            aria-autocomplete="list"
            aria-label="Standard or Certification"
          >
          <button type="button" class="autocomplete-clear" aria-label="Clear selection">√ó</button>
          <div class="autocomplete-dropdown hidden" role="listbox"></div>
        </div>
      </div>
    </div>

    <div class="results-count" id="results-count">
      Showing {totalListings} listings
    </div>

    <div class="certification-disclaimer">
      <div class="disclaimer-icon">‚ö†Ô∏è</div>
      <div class="disclaimer-content">
        <p>{CONTENT.disclaimer}</p>
        <p style="margin-top: 0.75rem;">
          <strong><a href={CONTENT.disclaimerLink.href}>{CONTENT.disclaimerLink.text}</a></strong>
        </p>
      </div>
    </div>

    <div class="listings-grid" id="listings-grid">
      {listings && listings.map((lab) => {
        const country = extractCountry(lab.address)
        const city = extractCity(lab.address)
        const categoryName = lab.category?.name || ''
        
        // Extract standards from capabilities
        const standards = lab.listing_capabilities?.map(cap => cap.standard).filter(Boolean) || []
        const standardsDisplay = standards.map(s => `${s.code} - ${s.name}`).join(', ')

        return (
          <div class="listing-card" data-country={country} data-city={city} data-category={categoryName} data-standards={standardsDisplay}>
            <div class="listing-header">
              <div>
                <h3 class="listing-title">
                  <a href={`/listing/${lab.slug}`}>{lab.business_name}</a>
                </h3>
                {categoryName && <span class="category-badge">{categoryName}</span>}
              </div>
              {lab.website_verified && (
                <span class="verified-badge">‚úì Verified</span>
              )}
            </div>

            {lab.description && (
              <p class="listing-description">{lab.description}</p>
            )}

            {standards.length > 0 && (
              <div class="listing-standards" style="margin-bottom: 1rem;">
                <div class="detail-item">
                  <span class="detail-icon">üî¨</span>
                  <span style="font-size: 0.9rem; color: #555;">
                    {standards.slice(0, 3).map(s => `${s.code}`).join(', ')}
                    {standards.length > 3 && ` +${standards.length - 3} more`}
                  </span>
                </div>
              </div>
            )}

             <div class="listing-details">
               {lab.address && (
                 <div class="detail-item">
                   <span class="detail-icon">üìç</span>
                   <span>{lab.address}</span>
                 </div>
               )}
               {lab.phone && (
                 <div class="detail-item">
                   <span class="detail-icon">üìû</span>
                   <span>{lab.phone}</span>
                 </div>
               )}
               {lab.email && (
                 <div class="detail-item">
                   <span class="detail-icon">‚úâÔ∏è</span>
                   <a href={`mailto:${lab.email}`}>{lab.email}</a>
                 </div>
               )}
               {lab.website && (
                 <div class="detail-item">
                   <span class="detail-icon">üåê</span>
                   <a href={getRedirectUrl(lab.website, lab.id)} target="_blank" rel="noopener noreferrer">{lab.website}</a>
                 </div>
               )}
             </div>

             <div class="listing-actions">
               {lab.website && (
                 <a href={getRedirectUrl(lab.website, lab.id)} class="visit-btn" target="_blank" rel="noopener noreferrer">
                   Visit Website
                 </a>
               )}
                <a href="/claim" class="claim-link" target="_blank">
                  Is this you? Claim
                </a>
             </div>
          </div>
        )
      })}
    </div>

    <!-- Low Density Fallback - Shown when < 5 results via JS -->
    <div class="low-density-fallback hidden" id="low-density-fallback" style="
      background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
      border: 2px solid #93c5fd;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(102,126,234,0.15);
    ">
      <div style="max-width: 600px; margin: 0 auto;">
        <h3 style="font-size: 1.75rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem;">
          Can't find the specific test you need?
        </h3>
        <p style="color: #1e40af; font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.6;">
          Our engineering team manually sources ISO 17025 accredited laboratories for specialized requirements.
          We'll find the perfect testing partner for your needs‚Äîat no cost to you.
        </p>
        <a
          href={MAILTO_LINKS.enterprisePlan}
          id="concierge-link"
          style="
            display: inline-block;
            background: #2563EB;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            padding: 1rem 2rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(102,126,234,0.3);
          "
          onmouseover="this.style.background='#059669'; this.style.transform='scale(1.05)'"
          onmouseout="this.style.background='#2563EB'; this.style.transform='scale(1)'"
        >
          Request Free Concierge Search ‚Üí
        </a>
        <p style="color: #2563EB; font-size: 0.9rem; margin-top: 1rem; font-weight: 600;">
          ‚ö° Average response time: 24 hours
        </p>
      </div>
    </div>

    <div class="no-results hidden" id="no-results">
      <h2>No listings found</h2>
      <p>Try adjusting your filters to see more results.</p>
    </div>
  </main>

  <Footer />

    <script define:vars={{ locationOptions, allCategories, allStandards }}>
    // Data for autocomplete dropdowns
    const locationData = JSON.parse(JSON.stringify(locationOptions || []))
    const categoriesData = JSON.parse(JSON.stringify(allCategories || []))
    const standardsData = JSON.parse(JSON.stringify(allStandards))

    // Filter functionality
    const locationFilter = document.getElementById('location-filter')
    const categoryFilter = document.getElementById('category-filter')
    const standardFilter = document.getElementById('standard-filter')
    const listingsGrid = document.getElementById('listings-grid')
    const resultsCount = document.getElementById('results-count')
    const noResults = document.getElementById('no-results')
    const lowDensityFallback = document.getElementById('low-density-fallback')
    const conciergeLink = document.getElementById('concierge-link')
    const listings = document.querySelectorAll('.listing-card')

    // Autocomplete class for intelligent dropdowns
    class AutocompleteDropdown {
      constructor(inputElement, options, displayField = 'name') {
        this.input = inputElement
        this.options = options
        this.displayField = displayField
        this.container = inputElement.parentElement
        this.dropdown = this.container.querySelector('.autocomplete-dropdown')
        this.clearBtn = this.container.querySelector('.autocomplete-clear')
        this.filteredOptions = []
        this.selectedIndex = -1
        this.isExpanded = false
        
        this.init()
      }

      init() {
        // Input event listeners
        this.input.addEventListener('input', this.debounce(() => this.handleInput(), 150))
        this.input.addEventListener('focus', () => this.showDropdown())
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e))
        this.input.addEventListener('blur', () => {
          setTimeout(() => this.hideDropdown(), 200) // Delay to allow option click
        })

        // Clear button
        this.clearBtn.addEventListener('click', () => this.clearSelection())

        // Click outside to close
        document.addEventListener('click', (e) => {
          if (!this.container.contains(e.target)) {
            this.hideDropdown()
          }
        })
      }

      debounce(func, wait) {
        let timeout
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout)
            func(...args)
          }
          clearTimeout(timeout)
          timeout = setTimeout(later, wait)
        }
      }

      handleInput() {
        const query = this.input.value.toLowerCase().trim()
        
        if (query === '') {
          this.filteredOptions = [...this.options]
        } else {
          this.filteredOptions = this.options.filter(option => {
            const text = this.getDisplayText(option).toLowerCase()
            return this.fuzzyMatch(query, text)
          }).sort((a, b) => {
            const scoreA = this.getMatchScore(query, this.getDisplayText(a).toLowerCase())
            const scoreB = this.getMatchScore(query, this.getDisplayText(b).toLowerCase())
            return scoreB - scoreA
          })
        }

        this.selectedIndex = -1
        this.renderOptions()
        this.showDropdown()
        this.updateClearButton()
        filterListings() // Trigger filtering
      }

      escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
      }

      fuzzyMatch(query, text) {
        if (query.length === 0) return true
        if (text.length === 0) return false

        // Convert to lowercase for case-insensitive matching
        const lowerQuery = query.toLowerCase()
        const lowerText = text.toLowerCase()

        // Check if query matches from the beginning
        if (lowerText.startsWith(lowerQuery)) return true

        // Check if query matches as a word (preceded by space, dash, or start)
        const wordRegex = new RegExp(`(?:^|[\\s\\-])(${this.escapeRegex(lowerQuery)})`, 'i')
        return wordRegex.test(lowerText)
      }

      getMatchScore(query, text) {
        const lowerQuery = query.toLowerCase()
        const lowerText = text.toLowerCase()

        // Exact match gets highest score
        if (lowerQuery === lowerText) return 100

        // Starts with query gets high score
        if (lowerText.startsWith(lowerQuery)) return 80

        // Word match gets medium score
        const wordRegex = new RegExp(`(?:^|[\\s\\-])(${this.escapeRegex(lowerQuery)})`, 'i')
        if (wordRegex.test(lowerText)) return 60

        // Contains query gets lower score
        if (lowerText.includes(lowerQuery)) return 40

        return 0
      }

      getDisplayText(option) {
        return option[this.displayField] || option.name || option.displayName || ''
      }

      renderOptions() {
        this.dropdown.innerHTML = ''

        if (this.filteredOptions.length === 0) {
          this.dropdown.innerHTML = '<div class="autocomplete-no-results">No matches found</div>'
          return
        }

        this.filteredOptions.forEach((option, index) => {
          const optionElement = document.createElement('div')
          optionElement.className = 'autocomplete-option'
          optionElement.setAttribute('role', 'option')
          optionElement.setAttribute('data-index', index)
          
          const displayText = this.getDisplayText(option)
          const highlightedText = this.highlightMatch(this.input.value.toLowerCase(), displayText)
          optionElement.innerHTML = highlightedText

          optionElement.addEventListener('click', () => this.selectOption(option))
          optionElement.addEventListener('mouseenter', () => this.selectIndex(index))
          
          this.dropdown.appendChild(optionElement)
        })
      }

      highlightMatch(query, text) {
        if (!query) return text
        
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi')
        return text.replace(regex, '<span class="autocomplete-match">$1</span>')
      }

      handleKeydown(e) {
        if (!this.isExpanded) {
          if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') {
            e.preventDefault()
            this.showDropdown()
          }
          return
        }

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault()
            this.selectIndex(Math.min(this.selectedIndex + 1, this.filteredOptions.length - 1))
            break
          case 'ArrowUp':
            e.preventDefault()
            this.selectIndex(Math.max(this.selectedIndex - 1, -1))
            break
          case 'Enter':
            e.preventDefault()
            if (this.selectedIndex >= 0) {
              this.selectOption(this.filteredOptions[this.selectedIndex])
            }
            break
          case 'Escape':
            this.hideDropdown()
            this.input.focus()
            break
        }
      }

      selectIndex(index) {
        this.selectedIndex = index
        const options = this.dropdown.querySelectorAll('.autocomplete-option')
        
        options.forEach((option, i) => {
          option.classList.toggle('selected', i === index)
          option.classList.toggle('highlighted', i === index)
        })

        // Scroll into view if needed
        if (index >= 0 && options[index]) {
          options[index].scrollIntoView({ block: 'nearest' })
        }
      }

      selectOption(option) {
        const displayText = this.getDisplayText(option)
        this.input.value = displayText
        this.input.setAttribute('data-selected-value', displayText)
        this.hideDropdown()
        this.updateClearButton()
        filterListings() // Trigger filtering
      }

      clearSelection() {
        this.input.value = ''
        this.input.removeAttribute('data-selected-value')
        this.hideDropdown()
        this.updateClearButton()
        filterListings() // Trigger filtering
      }

      updateClearButton() {
        this.clearBtn.classList.toggle('visible', this.input.value.length > 0)
      }

      showDropdown() {
        if (this.filteredOptions.length === 0 && this.input.value === '') {
          this.hideDropdown()
          return
        }
        
        this.dropdown.classList.remove('hidden')
        this.input.setAttribute('aria-expanded', 'true')
        this.isExpanded = true
      }

      hideDropdown() {
        this.dropdown.classList.add('hidden')
        this.input.setAttribute('aria-expanded', 'false')
        this.isExpanded = false
        this.selectedIndex = -1
      }

      getValue() {
        return this.input.getAttribute('data-selected-value') || this.input.value
      }
    }

    // Initialize autocomplete dropdowns
    const locationAutocomplete = new AutocompleteDropdown(locationFilter, locationData, 'displayName')
    const categoryAutocomplete = new AutocompleteDropdown(categoryFilter, categoriesData, 'name')
    const standardAutocomplete = new AutocompleteDropdown(standardFilter, standardsData, 'displayName')

    function filterListings() {
      const selectedLocation = locationAutocomplete.getValue().toLowerCase()
      const selectedCategory = categoryAutocomplete.getValue().toLowerCase()
      const selectedStandard = standardAutocomplete.getValue().toLowerCase()

      let visibleCount = 0

      listings.forEach(listing => {
        const country = (listing.dataset.country || '').toLowerCase()
        const city = (listing.dataset.city || '').toLowerCase()
        const category = (listing.dataset.category || '').toLowerCase()
        const standards = (listing.dataset.standards || '').toLowerCase()

        // Location matching: check both country and city fields
        const matchesLocation = !selectedLocation ||
          country === selectedLocation ||
          city === selectedLocation

        const matchesCategory = !selectedCategory || category === selectedCategory
        const matchesStandard = !selectedStandard || standards.includes(selectedStandard)

        if (matchesLocation && matchesCategory && matchesStandard) {
          listing.classList.remove('hidden')
          visibleCount++
        } else {
          listing.classList.add('hidden')
        }
      })

      // Update results count
      resultsCount.textContent = `Showing ${visibleCount} listing${visibleCount !== 1 ? 's' : ''}`

      // Show/hide no results message
      if (visibleCount === 0) {
        listingsGrid.classList.add('hidden')
        noResults.classList.remove('hidden')
        lowDensityFallback.classList.add('hidden')
      } else {
        listingsGrid.classList.remove('hidden')
        noResults.classList.add('hidden')

        // Show low-density fallback for < 5 results
        if (visibleCount < 5) {
          lowDensityFallback.classList.remove('hidden')

          // Update mailto link with filter context in subject
          let subject = 'Request Free Concierge Search'
          const contextParts = []
          if (categoryAutocomplete.getValue()) contextParts.push(categoryAutocomplete.getValue())
          if (locationAutocomplete.getValue()) {
            // Extract location name without type suffix
            const locationName = locationAutocomplete.getValue().replace(/\s*\([^)]*\)$/, '')
            contextParts.push(locationName)
          }
          if (standardAutocomplete.getValue()) contextParts.push(standardAutocomplete.getValue())
          if (contextParts.length > 0) {
            subject += ' - ' + contextParts.join(', ')
          }
          conciergeLink.href = `${MAILTO_LINKS.enterprisePlan}&body=${encodeURIComponent(subject)}`
        } else {
          lowDensityFallback.classList.add('hidden')
        }
      }
    }

    // Check URL parameters for pre-filtering
    const urlParams = new URLSearchParams(window.location.search)

    function setAutocompleteValue(autocomplete, value) {
      if (value) {
        autocomplete.input.value = value
        autocomplete.input.setAttribute('data-selected-value', value)
        autocomplete.updateClearButton()
      }
    }

    // Handle legacy URL parameters for backward compatibility
    if (urlParams.has('country')) {
      const countryValue = urlParams.get('country')
      setAutocompleteValue(locationAutocomplete, `${countryValue} (Country)`)
    }
    if (urlParams.has('city')) {
      const cityValue = urlParams.get('city')
      setAutocompleteValue(locationAutocomplete, `${cityValue} (City)`)
    }
    if (urlParams.has('location')) {
      setAutocompleteValue(locationAutocomplete, urlParams.get('location'))
    }
    if (urlParams.has('category')) {
      setAutocompleteValue(categoryAutocomplete, urlParams.get('category'))
    }
    if (urlParams.has('standard')) {
      setAutocompleteValue(standardAutocomplete, urlParams.get('standard'))
    }

    // Initial filter if URL params exist
    if (urlParams.toString()) {
      filterListings()
    }

    // Claim button functionality
    document.addEventListener('DOMContentLoaded', () => {
      const claimLinks = document.querySelectorAll('.claim-link')

      claimLinks.forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault()

          const listingId = link.getAttribute('data-listing-id')
          const listingName = link.getAttribute('data-listing-name')

          // For now, always redirect to claim page (simplified for testing)
          window.location.href = `/claim?id=${listingId}&provider=${encodeURIComponent(listingName)}`
        })
      })
    })
      })
    })
  </script>
</body>
</html>
