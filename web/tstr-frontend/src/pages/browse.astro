---
import { supabase } from '../lib/supabase'
import { CONTENT } from '../lib/contacts'
import Footer from '../components/Footer.astro'

// Fetch all active listings with location hierarchy and category
const { data: listings, error } = await supabase
  .from('listings')
  .select(`
    *,
    category:category_id (
      id,
      name,
      slug
    ),
    location:location_id (
      id,
      name,
      slug,
      level,
      parent:parent_id (
        id,
        name,
        slug,
        level,
        parent:parent_id (
          id,
          name,
          slug,
          level
        )
      )
    )
  `)
  .eq('status', 'active')
  .order('created_at', { ascending: false })

// Fetch categories with active listings only for filter dropdown
const { data: categoriesData } = await supabase
  .from('categories')
  .select(`
    id,
    name,
    slug,
    listings:listings!category_id(count)
  `)
  .order('name', { ascending: true })

// Filter to only categories with active listings
const allCategories = (categoriesData || [])
  .filter(cat => cat.listings && cat.listings[0]?.count > 0)
  .map(cat => ({ id: cat.id, name: cat.name, slug: cat.slug }))

// Extract unique countries and cities from location hierarchy
const getCountryFromLocation = (location) => {
  if (!location) return null
  if (location.level === 'country') return { name: location.name, slug: location.slug }
  if (location.parent?.level === 'country') return { name: location.parent.name, slug: location.parent.slug }
  if (location.parent?.parent?.level === 'country') return { name: location.parent.parent.name, slug: location.parent.parent.slug }
  return null
}

const getCityFromLocation = (location) => {
  if (!location) return null
  if (location.level === 'city') return { name: location.name, slug: location.slug }
  return null
}

const countryMap = new Map()
const cityMap = new Map()

listings?.forEach(listing => {
  const country = getCountryFromLocation(listing.location)
  if (country) countryMap.set(country.slug, country.name)

  const city = getCityFromLocation(listing.location)
  if (city) cityMap.set(city.slug, city.name)
})

const countries = Array.from(countryMap.entries()).map(([slug, name]) => ({ slug, name })).sort((a, b) => a.name.localeCompare(b.name))
const cities = Array.from(cityMap.entries()).map(([slug, name]) => ({ slug, name })).sort((a, b) => a.name.localeCompare(b.name))

const totalListings = listings?.length || 0

// Helper functions for filtering
const extractCountry = (address) => {
  if (!address) return ''
  const parts = address.split(',').map(p => p.trim())
  return parts[parts.length - 1] || ''
}

const extractCity = (address) => {
  if (!address) return ''
  const parts = address.split(',').map(p => p.trim())
  return parts[0] || ''
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Testing Laboratories | TSTR Hub</title>
  <meta name="description" content="Browse {totalListings} verified testing service providers by country, city, and specialty. Oil & Gas, Pharmaceutical, Environmental testing labs worldwide.">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7003918988204966"
     crossorigin="anonymous"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .breadcrumb {
      margin-top: 1rem;
      opacity: 0.9;
    }

    .breadcrumb a {
      color: white;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    .filters {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .filter-group select {
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .results-count {
      background: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      text-align: center;
      font-weight: 600;
      color: #667eea;
    }

    .listings-grid {
      display: grid;
      gap: 1.5rem;
    }

    .listing-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 2rem;
      transition: all 0.3s ease;
    }

    .listing-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102,126,234,0.2);
      transform: translateY(-2px);
    }

    .listing-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .listing-title {
      color: #667eea;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .listing-title a {
      color: #667eea;
      text-decoration: none;
      transition: color 0.2s;
    }

    .listing-title a:hover {
      color: #764ba2;
    }

    .category-badge {
      background: #f0f0f0;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      color: #555;
      display: inline-block;
    }

    .verified-badge {
      background: #4caf50;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .listing-description {
      color: #666;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .listing-details {
      display: grid;
      gap: 0.5rem;
      color: #555;
      font-size: 0.95rem;
    }

    .detail-item {
      display: flex;
      gap: 0.5rem;
    }

    .detail-icon {
      color: #667eea;
      font-weight: 600;
    }

    .detail-item a {
      color: #667eea;
      text-decoration: none;
    }

    .detail-item a:hover {
      text-decoration: underline;
    }

    .no-results {
      background: white;
      padding: 3rem;
      border-radius: 12px;
      text-align: center;
      color: #666;
    }

    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 3rem;
    }

    footer a {
      color: white;
      text-decoration: none;
      margin: 0 1rem;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }

    .certification-disclaimer {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8cc 100%);
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .disclaimer-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
      margin-top: 0.25rem;
    }

    .disclaimer-content {
      flex: 1;
    }

    .disclaimer-content p {
      margin: 0;
      font-size: 0.95rem;
      color: #333;
      line-height: 1.5;
    }

    @media (max-width: 768px) {
      .certification-disclaimer {
        flex-direction: column;
        gap: 0.75rem;
      }

      .disclaimer-icon {
        margin-top: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Browse Testing Laboratories</h1>
    <p class="breadcrumb">
      <a href="/">Home</a> / Browse All Listings | <a href="/search/standards">üî¨ Search by Standard</a>
    </p>
  </header>

  <main>
    <div class="filters">
      <div class="filter-group">
        <label for="country-filter">Filter by Country</label>
        <select id="country-filter">
          <option value="">All Countries</option>
          {countries.map(country => (
            <option value={country.name}>{country.name}</option>
          ))}
        </select>
      </div>

      <div class="filter-group">
        <label for="city-filter">Filter by City</label>
        <select id="city-filter">
          <option value="">All Cities</option>
          {cities.map(city => (
            <option value={city.name}>{city.name}</option>
          ))}
        </select>
      </div>

      <div class="filter-group">
        <label for="category-filter">Filter by Category</label>
        <select id="category-filter">
          <option value="">All Categories</option>
          {allCategories && allCategories.map(category => (
            <option value={category.name}>{category.name}</option>
          ))}
        </select>
      </div>
    </div>

    <div class="results-count" id="results-count">
      Showing {totalListings} listings
    </div>

    <div class="certification-disclaimer">
      <div class="disclaimer-icon">‚ö†Ô∏è</div>
      <div class="disclaimer-content">
        <p>{CONTENT.disclaimer}</p>
        <p style="margin-top: 0.75rem;">
          <strong><a href={CONTENT.disclaimerLink.href}>{CONTENT.disclaimerLink.text}</a></strong>
        </p>
      </div>
    </div>

    <div class="listings-grid" id="listings-grid">
      {listings && listings.map((lab) => {
        const country = extractCountry(lab.address)
        const city = extractCity(lab.address)
        const categoryName = lab.category?.name || ''

        return (
          <div class="listing-card" data-country={country} data-city={city} data-category={categoryName}>
            <div class="listing-header">
              <div>
                <h3 class="listing-title">
                  <a href={`/listing/${lab.slug}`}>{lab.business_name}</a>
                </h3>
                {categoryName && <span class="category-badge">{categoryName}</span>}
              </div>
              {lab.website_verified && (
                <span class="verified-badge">‚úì Verified</span>
              )}
            </div>

            {lab.description && (
              <p class="listing-description">{lab.description}</p>
            )}

            <div class="listing-details">
              {lab.address && (
                <div class="detail-item">
                  <span class="detail-icon">üìç</span>
                  <span>{lab.address}</span>
                </div>
              )}
              {lab.phone && (
                <div class="detail-item">
                  <span class="detail-icon">üìû</span>
                  <span>{lab.phone}</span>
                </div>
              )}
              {lab.email && (
                <div class="detail-item">
                  <span class="detail-icon">‚úâÔ∏è</span>
                  <a href={`mailto:${lab.email}`}>{lab.email}</a>
                </div>
              )}
              {lab.website && (
                <div class="detail-item">
                  <span class="detail-icon">üåê</span>
                  <a href={lab.website} target="_blank" rel="noopener noreferrer">{lab.website}</a>
                </div>
              )}
            </div>
          </div>
        )
      })}
    </div>

    <!-- Low Density Fallback - Shown when < 5 results via JS -->
    <div class="low-density-fallback hidden" id="low-density-fallback" style="
      background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
      border: 2px solid #93c5fd;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 2px 8px rgba(102,126,234,0.15);
    ">
      <div style="max-width: 600px; margin: 0 auto;">
        <h3 style="font-size: 1.75rem; font-weight: 700; color: #1e3a8a; margin-bottom: 1rem;">
          Can't find the specific test you need?
        </h3>
        <p style="color: #1e40af; font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.6;">
          Our engineering team manually sources ISO 17025 accredited laboratories for specialized requirements.
          We'll find the perfect testing partner for your needs‚Äîat no cost to you.
        </p>
        <a
          href="/contact?subject=Concierge+Request"
          id="concierge-link"
          style="
            display: inline-block;
            background: #667eea;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            padding: 1rem 2rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(102,126,234,0.3);
          "
          onmouseover="this.style.background='#764ba2'; this.style.transform='scale(1.05)'"
          onmouseout="this.style.background='#667eea'; this.style.transform='scale(1)'"
        >
          Request Free Concierge Search ‚Üí
        </a>
        <p style="color: #667eea; font-size: 0.9rem; margin-top: 1rem; font-weight: 600;">
          ‚ö° Average response time: 24 hours
        </p>
      </div>
    </div>

    <div class="no-results hidden" id="no-results">
      <h2>No listings found</h2>
      <p>Try adjusting your filters to see more results.</p>
    </div>
  </main>

  <Footer />

  <script>
    // Filter functionality
    const countryFilter = document.getElementById('country-filter')
    const cityFilter = document.getElementById('city-filter')
    const categoryFilter = document.getElementById('category-filter')
    const listingsGrid = document.getElementById('listings-grid')
    const resultsCount = document.getElementById('results-count')
    const noResults = document.getElementById('no-results')
    const lowDensityFallback = document.getElementById('low-density-fallback')
    const conciergeLink = document.getElementById('concierge-link')
    const listings = document.querySelectorAll('.listing-card')

    function filterListings() {
      const selectedCountry = countryFilter.value.toLowerCase()
      const selectedCity = cityFilter.value.toLowerCase()
      const selectedCategory = categoryFilter.value.toLowerCase()

      let visibleCount = 0

      listings.forEach(listing => {
        const country = (listing.dataset.country || '').toLowerCase()
        const city = (listing.dataset.city || '').toLowerCase()
        const category = (listing.dataset.category || '').toLowerCase()

        const matchesCountry = !selectedCountry || country === selectedCountry
        const matchesCity = !selectedCity || city === selectedCity
        const matchesCategory = !selectedCategory || category === selectedCategory

        if (matchesCountry && matchesCity && matchesCategory) {
          listing.classList.remove('hidden')
          visibleCount++
        } else {
          listing.classList.add('hidden')
        }
      })

      // Update results count
      resultsCount.textContent = `Showing ${visibleCount} listing${visibleCount !== 1 ? 's' : ''}`

      // Show/hide no results message
      if (visibleCount === 0) {
        listingsGrid.classList.add('hidden')
        noResults.classList.remove('hidden')
        lowDensityFallback.classList.add('hidden')
      } else {
        listingsGrid.classList.remove('hidden')
        noResults.classList.add('hidden')

        // Show low-density fallback for < 5 results
        if (visibleCount < 5) {
          lowDensityFallback.classList.remove('hidden')

          // Update concierge link with filter context
          const params = new URLSearchParams()
          params.set('subject', 'Concierge Request')
          if (categoryFilter.value) params.set('category', categoryFilter.value)
          if (countryFilter.value) params.set('country', countryFilter.value)
          if (cityFilter.value) params.set('city', cityFilter.value)
          conciergeLink.href = `/contact?${params.toString()}`
        } else {
          lowDensityFallback.classList.add('hidden')
        }
      }
    }

    // Add event listeners
    countryFilter.addEventListener('change', filterListings)
    cityFilter.addEventListener('change', filterListings)
    categoryFilter.addEventListener('change', filterListings)

    // Check URL parameters for pre-filtering
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.has('country')) {
      countryFilter.value = urlParams.get('country')
      filterListings()
    }
    if (urlParams.has('city')) {
      cityFilter.value = urlParams.get('city')
      filterListings()
    }
    if (urlParams.has('category')) {
      categoryFilter.value = urlParams.get('category')
      filterListings()
    }
  </script>
</body>
</html>
