---
// src/pages/[category]/[region]/index.astro
import { supabase } from '../../../lib/supabase';
import { MAILTO_LINKS } from '../../../lib/contacts';
import Footer from '../../../components/Footer.astro';
import { getRedirectUrl } from '../../../lib/redirect';

// Enable static prerendering at build time
export const prerender = true;

// 1. getStaticPaths: Generate pages for each category/region combination
export async function getStaticPaths() {
  // Fetch all categories
  const { data: categories } = await supabase
    .from('categories')
    .select('slug');

  // Fetch all regions currently in use in listings (regardless of status)
  const { data: listingRegions } = await supabase
    .from('listings')
    .select('region');

  if (!categories || !listingRegions) {
    return [];
  }

  // Define core regions to ensure they always exist
  const uniqueRegions = new Set(['global', 'europe', 'north-america', 'asia', 'oceania', 'africa', 'south-america']);
  
  // Add any regions found in listings
  listingRegions.forEach(l => {
    if (l.region) uniqueRegions.add(l.region.toLowerCase());
  });

  // Create cross-join of all categories and all regions
  const paths = [];
  categories.forEach(cat => {
    uniqueRegions.forEach(region => {
      paths.push({
        params: { 
          category: cat.slug, 
          region: region 
        }
      });
    });
  });

  return paths;
}

// 2. Page rendering: Fetch data for this specific page
const { category, region } = Astro.params;

// Fetch category metadata
const { data: categoryData } = await supabase
  .from('categories')
  .select('id, name, slug, description')
  .eq('slug', category)
  .single();

// Fetch listings for this category/region
const { data: pageListings, error: listingsError } = await supabase
  .from('listings')
  .select(`
    *,
    category:category_id (
      id,
      name,
      slug
    ),
    location:location_id (
      id,
      name,
      slug
    )
  `)
  .eq('status', 'active')
  .eq('region', region)
  .eq('category_id', categoryData?.id || '00000000-0000-0000-0000-000000000000')
  .order('priority_rank', { ascending: false })
  .order('created_at', { ascending: false });

import { formatTitle, formatDescription } from '../../../lib/seo';

// SEO-friendly titles
const titleCat = categoryData?.name || category.charAt(0).toUpperCase() + category.slice(1);
const titleReg = region.toUpperCase();
const listingCount = pageListings?.length || 0;

// Helper: Convert "Testers" to "Testing" for SEO hybrid hook
const getTestingServiceName = (categoryName: string) => {
  return categoryName.replace('Testers', 'Testing');
};

const testingServiceName = getTestingServiceName(titleCat);

// Optimized SEO parts
const pageTitle = formatTitle([titleCat, titleReg]);
const pageDescription = formatDescription(
  `Find ${listingCount} verified ${titleCat.toLowerCase()} and ${testingServiceName.toLowerCase()} in ${titleReg}. Compare ISO 17025 labs and certification bodies. Get quotes from certified providers.`
);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <script>function initApollo(){var n=Math.random().toString(36).substring(7),o=document.createElement("script");
  o.src="https://assets.apollo.io/micro/website-tracker/tracker.iife.js?nocache="+n,o.async=!0,o.defer=!0,
  o.onload=function(){window.trackingFunctions.onLoad({appId:"6979e8021ac917001927e9b2"})},
  document.head.appendChild(o)}initApollo();</script>
</head>

  <body class="bg-gray-50 min-h-screen font-sans text-gray-900">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm p-4">
      <div class="max-w-6xl mx-auto">
        <a href="/" class="font-bold text-xl hover:text-blue-600 transition">
          TSTR<span class="text-blue-600">.directory</span>
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-6">

      <!-- Breadcrumbs -->
      <div class="text-sm text-gray-500 mb-4">
        <a href="/" class="hover:underline hover:text-blue-600">Home</a>
        <span class="mx-2">‚Ä∫</span>
        <a href={`/${category}`} class="hover:underline hover:text-blue-600">{titleCat}</a>
        <span class="mx-2">‚Ä∫</span>
        <span class="text-gray-900 font-medium">{titleReg}</span>
      </div>

      <!-- Page Header -->
      <h1 class="text-3xl md:text-4xl font-bold mb-2">
        {titleCat} in {titleReg}
      </h1>

      <!-- H2: SEO Payload (Hybrid Hook Strategy) -->
      <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-4">
        High-Value {testingServiceName} in {titleReg}
      </h2>

      <!-- SEO-enhanced intro -->
      <p class="text-gray-600 text-base mb-4">
        Find verified <strong>{titleCat.toLowerCase()}</strong> and compare
        <strong>{testingServiceName.toLowerCase()}</strong> from ISO 17025
        accredited laboratories in {titleReg}.
        {categoryData?.description && ` Expert providers for ${categoryData.description.toLowerCase()}.`}
      </p>

      <p class="text-gray-600 mb-8 text-lg">
        {listingCount === 0 ? 'No' : listingCount} verified {listingCount === 1 ? 'laboratory' : 'laboratories'} and certification {listingCount === 1 ? 'body' : 'bodies'}.
      </p>

      <!-- Error Handling -->
      {listingsError && (
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
          <p class="text-red-800 text-sm">
            ‚ö†Ô∏è Error loading listings. Please try again later.
          </p>
        </div>
      )}

      <!-- Listings Grid -->
      {pageListings && pageListings.length > 0 ? (
        <div class="grid gap-6">
          {pageListings.map((listing) => (
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition">

              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-xl font-bold text-blue-900">
                    {listing.business_name}
                  </h3>

                  <div class="text-sm text-gray-500 mt-1 flex flex-wrap gap-3">
                    <span>üìç {listing.location?.name || listing.region?.toUpperCase()}</span>
                    {listing.featured && (
                      <span class="text-yellow-600 font-semibold">‚≠ê Featured</span>
                    )}
                    {listing.verified && (
                      <span class="text-green-600 font-semibold">‚úì Verified</span>
                    )}
                  </div>

                  {listing.description && (
                    <p class="text-gray-700 mt-3 text-sm line-clamp-2">
                      {listing.description}
                    </p>
                  )}
                </div>

                {listing.website && (
                  <a
                    href={getRedirectUrl(listing.website, listing.id)}
                    target="_blank"
                    rel="nofollow noopener noreferrer"
                    class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition whitespace-nowrap"
                  >
                    Visit Website
                  </a>
                )}
              </div>

              <!-- Claim Prompt for Unclaimed Listings -->
              {!listing.claimed && (
                <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 text-xs text-yellow-800">
                  ‚ö†Ô∏è Is this your lab?
                  <a href="/claim" class="underline font-bold hover:text-yellow-900">
                    Claim this profile
                  </a>
                  to manage your listing.
                </div>
              )}
            </div>
          ))}

          {/* Low Density Fallback - Show when fewer than 5 results */}
          {listingCount < 5 && (
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-8 mt-8 text-center shadow-sm hover:shadow-md transition-shadow">
              <div class="max-w-2xl mx-auto">
                <h3 class="text-2xl font-bold text-blue-900 mb-3">
                  Can't find the right {titleCat.toLowerCase()} in {titleReg}?
                </h3>
                <p class="text-blue-800 text-lg mb-6 leading-relaxed">
                  Our engineering team manually sources ISO 17025 accredited laboratories for specialized requirements.
                  We'll find the perfect testing partner for your needs‚Äîat no cost to you.
                </p>
                <a
                  href={`${MAILTO_LINKS.enterprisePlan}&body=Concierge Search Request for ${encodeURIComponent(titleCat)} in ${encodeURIComponent(titleReg)}`}
                  class="inline-block bg-blue-600 text-white font-bold text-lg py-4 px-8 rounded-lg hover:bg-blue-700 hover:scale-105 transition-all shadow-md hover:shadow-lg"
                >
                  Request Free Concierge Search ‚Üí
                </a>
                <p class="text-sm text-blue-600 mt-4 font-medium">
                  ‚ö° Average response time: 24 hours
                </p>
              </div>
            </div>
          )}
        </div>
      ) : (
        <!-- Empty State -->
        <div class="text-center py-16 bg-white rounded-lg border-2 border-dashed border-gray-300">
          <p class="text-gray-500 text-lg mb-2">
            No {titleCat.toLowerCase()} listed in {titleReg} yet.
          </p>
          <a href="/contact" class="text-blue-600 font-bold hover:underline">
            Be the first to list here ‚Üí
          </a>
        </div>
      )}

    </main>

    <!-- Footer -->
    <Footer />
  </body>
</html>
