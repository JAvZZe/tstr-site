---
export const prerender = false // Force SSR for auth page

// Import Supabase client
import { supabaseBrowser } from '../../lib/supabase-browser'
import { MAILTO_LINKS, CONTACTS, getMailtoLink } from '../../lib/contacts'
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Subscription - TSTR Hub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      padding-bottom: 4rem;
    }

    header {
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      padding: 3rem 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      opacity: 0.3;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }

    .container {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .dashboard-grid, :global(.dashboard-grid) {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card, :global(.card) {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .card h3, :global(.card h3) {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    .card h3::before, :global(.card h3::before) {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      border-radius: 2px;
    }

    .card-content, :global(.card-content) {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      flex: 1;
    }

    .info-row, :global(.info-row) {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
    }

    .info-row:hover, :global(.info-row:hover) {
      background-color: #f9f9f9;
      border-radius: 6px;
      margin: 0 -1rem;
      padding: 1rem;
    }

    .info-row:last-child, :global(.info-row:last-child) {
      border-bottom: none;
      padding-bottom: 0;
    }

    .info-content, :global(.info-content) {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .info-icon, :global(.info-icon) {
      width: 20px !important;
      height: 20px !important;
      color: #000080;
      flex-shrink: 0;
    }

    .info-text, :global(.info-text) {
      flex: 1;
    }

    .info-label, :global(.info-label) {
      color: #666;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      display: block;
    }

    .info-value, :global(.info-value) {
      color: #333;
      font-weight: 600;
      font-size: 1rem;
    }

    .tier-badge, :global(.tier-badge) {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tier-badge:hover, :global(.tier-badge:hover) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .tier-badge.free, :global(.tier-badge.free) {
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      color: #666;
    }

    .tier-badge.basic, :global(.tier-badge.basic) {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1976d2;
    }

    .tier-badge.professional, :global(.tier-badge.professional) {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
    }

    .tier-badge.premium, :global(.tier-badge.premium) {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
    }

    .tier-badge.enterprise, :global(.tier-badge.enterprise) {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
    }

    .benefits-list, :global(.benefits-list) {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .benefits-list li, :global(.benefits-list li) {
      padding: 0.875rem 0;
      color: #555;
      font-size: 0.95rem;
      display: flex;
      align-items: flex-start;
      gap: 0.875rem;
      border-bottom: 1px solid #f8f9fa;
      transition: background-color 0.2s ease;
    }

    .benefits-list li:hover {
      background-color: #f8f9fa;
      border-radius: 6px;
      margin: 0 -1rem;
      padding: 0.875rem 1rem;
    }

    .benefits-list li:last-child {
      border-bottom: none;
    }

    .benefits-list li:before, :global(.benefits-list li:before) {
      content: '‚úì';
      color: #000080;
      font-weight: bold;
      font-size: 1.1rem;
      flex-shrink: 0;
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .full-width, :global(.full-width) {
      grid-column: 1 / -1;
    }

    .btn, :global(.btn) {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 0.375rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 36px;
    }

    .btn-primary, :global(.btn-primary) {
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover, :global(.btn-primary:hover) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary, :global(.btn-secondary) {
      background: white;
      color: #000080;
      border: 2px solid #000080;
    }

    .btn-secondary:hover, :global(.btn-secondary:hover) {
      background: #f8f9ff;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(102, 126, 234, 0.2);
    }

    .btn-danger, :global(.btn-danger) {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
    }

    .btn-danger:hover, :global(.btn-danger:hover) {
      background: linear-gradient(135deg, #ee5a52 0%, #dc4545 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .back-link {
      display: inline-block;
      color: #000080;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 2rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #32CD32;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      header {
        padding: 1.5rem 1rem;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1.5rem;
      }
    }

    /* Subscription Specific Additions */
    .upgrade-card.recommended {
      border: 2px solid #000080;
      background: linear-gradient(135deg, #f0f4ff 0%, #fff5f8 100%);
    }

    .premium-badge {
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(135deg, #000080 0%, #32CD32 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .plan-price-large {
      font-size: 2rem;
      font-weight: 800;
      color: #000080;
      margin: 1rem 0;
    }

    .card-footer {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #f0f0f0;
    }
  </style>
</head>
<body>
  <header>
    <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center;">
        <a href="/" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
          <img src="/TSTR-Logo-60px.png" alt="TSTR Logo" style="height: 50px; width: auto; margin-right: 1.25rem; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 12px;"/>
          <div style="text-align: left;">
            <h1 style="font-size: 1.5rem; margin: 0; line-height: 1;">TSTR Hub</h1>
            <p style="font-size: 0.9rem; margin: 0; opacity: 0.9;">Subscription Management</p>
          </div>
        </a>
      </div>
      <div class="breadcrumb" style="margin: 0;">
        <a href="/">Home</a>
        <span>‚Ä∫</span>
        <a href="/account">Account</a>
        <span>‚Ä∫</span>
        <span>Subscription</span>
      </div>
    </div>
  </header>

  <div class="container">
    <a href="/account" class="back-link">‚Üê Back to Account</a>

    <div id="content">
      <div class="loading">Loading your subscription details...</div>
    </div>
  </div>

  <script>
    import { supabaseBrowser, supabaseAnonJwt } from '../../lib/supabase-browser'
    import { MAILTO_LINKS, CONTACTS } from '../../lib/contacts'

    async function loadSubscriptionPage() {
      const contentDiv = document.getElementById('content')

      try {
        // Get current session
        const { data: { session }, error: sessionError } = await supabaseBrowser.auth.getSession()

        if (sessionError || !session) {
          window.location.href = '/login'
          return
        }

        const user = session.user

        // Fetch user profile
        const { data: profile, error: profileError } = await supabaseBrowser
          .from('user_profiles')
          .select('*')
          .eq('id', user.id)
          .single()

        if (profileError) {
          console.error('Profile fetch error:', profileError)
          contentDiv.innerHTML = `
            <div class="error-message">
              Failed to load subscription details. Please try again later.
            </div>
          `
          return
        }

        console.log('Subscription Profile Loaded:', profile)
        
        let currentTier = profile?.subscription_tier || 'free'
        
        // Define tier information (same as before)
        const tierInfo = {
          free: {
            name: 'Free',
            price: '$0/month',
            benefits: [
              'Basic directory listing',
              'Company name & description',
              'General location display',
              'Browse all listings'
            ]
          },
          basic: {
            name: 'Basic',
            price: '$0/month',
            benefits: [
              'Everything in Free',
              'Sign up to unlock contact details',
              'Basic search filters',
              'Save favorite listings'
            ]
          },
          professional: {
            name: 'Professional',
            price: '$295/month',
            benefits: [
              'Everything in Basic',
              'Full contact information displayed',
              'Detailed capabilities & certifications',
              'Equipment list',
              'Up to 3 case studies',
              'Basic analytics dashboard',
              'Email support'
            ]
          },
          premium: {
            name: 'Premium',
            price: '$795/month',
            benefits: [
              'Everything in Professional',
              'Priority ranking in searches',
              'Real-time lead notifications',
              'Featured case study section',
              'Advanced analytics dashboard',
              'Monthly performance reports',
              '48-hour early access to RFQs',
              'Priority email support'
            ]
          },
          enterprise: {
            name: 'Enterprise',
            price: 'Custom',
            benefits: [
              'Everything in Premium',
              'Category exclusivity',
              'Full analytics API access',
              'Custom CRM integration',
              'Co-branded marketing',
              'Dedicated account manager',
              'White-label profile widget',
              'Custom contract terms'
            ]
          }
        }

        // Validate tier existence
        if (!tierInfo[currentTier]) {
          console.error(`Invalid tier found: "${currentTier}". Falling back to free.`)
          currentTier = 'free'
        }

        const currentTierData = tierInfo[currentTier]

        // Determine available upgrades
        const upgradeTiers = []
        if (currentTier === 'free' || currentTier === 'basic') {
          upgradeTiers.push('professional', 'premium', 'enterprise')
        } else if (currentTier === 'professional') {
          upgradeTiers.push('premium', 'enterprise')
        } else if (currentTier === 'premium') {
          upgradeTiers.push('enterprise')
        }

        const upgradeHtml = upgradeTiers.map(tier => {
          const tierData = tierInfo[tier]
          const isRecommended = tier === 'professional' && currentTier === 'free'
          const additionalBenefits = tierData.benefits.slice(currentTierData.benefits.length)

          return `
            <div class="card ${isRecommended ? 'recommended' : ''}">
              ${isRecommended ? '<span class="premium-badge">MEMBER FAVORITE</span>' : ''}
              <h3>${tierData.name}</h3>
              <div class="card-content">
                <div class="plan-price-large">${tierData.price}</div>
                <div style="flex: 1;">
                   <span class="info-label">Additional Benefits:</span>
                   <ul class="benefits-list" style="margin-top: 0.5rem;">
                     ${additionalBenefits.map(benefit => `<li>${benefit}</li>`).join('')}
                   </ul>
                </div>
                <div class="card-footer" style="padding-top: 1rem;">
                  ${tier === 'enterprise' ?
                    `<a href="${MAILTO_LINKS.enterprisePlan}" class="btn btn-primary" style="width: 100%;">
                      <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                      </svg>
                      Contact Sales
                    </a>` :
                    `<button class="btn btn-primary" style="width: 100%;" onclick="handlePayPalSubscribe('${tier}', this)">
                      <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/>
                      </svg>
                      Subscribe Now
                    </button>`
                  }
                </div>
              </div>
            </div>
          `
        }).join('')

        const isPaidPlan = ['professional', 'premium'].includes(currentTier);

        contentDiv.innerHTML = `
          <div class="dashboard-grid">
            <div class="card full-width">
              <h3>üíé Your Current Plan</h3>
              <div class="card-content">
                <div class="info-row">
                  <div class="info-content">
                    <svg class="info-icon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="info-text">
                      <span class="info-label">Plan Name</span>
                      <span class="info-value"><span class="tier-badge ${currentTier}">${currentTierData.name}</span></span>
                    </div>
                  </div>
                  <div class="info-text" style="text-align: right;">
                    <span class="info-label">Price</span>
                    <span class="info-value">${currentTierData.price}</span>
                  </div>
                </div>
                
                <div style="margin-top: 1rem;">
                  <span class="info-label">Included Benefits:</span>
                  <ul class="benefits-list" style="margin-top: 0.5rem;">
                    ${currentTierData.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                  </ul>
                </div>

                ${isPaidPlan ? `
                  <div class="card-footer">
                    <button class="btn btn-danger" onclick="handleCancelSubscription(this)">
                      <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                      </svg>
                      Cancel Subscription
                    </button>
                  </div>
                ` : ''}
              </div>
            </div>

            ${upgradeTiers.length > 0 ? `
              <div class="full-width" style="margin-top: 2rem; margin-bottom: 1rem;">
                <h2 style="font-size: 1.5rem; color: #333; font-weight: 700;">üöÄ Upgrade Your Plan</h2>
                <p style="color: #666; margin-top: 0.5rem;">Select a plan that fits your business needs.</p>
              </div>
              
              <div class="dashboard-grid full-width">
                ${upgradeHtml}
              </div>
            ` : ''}

            <div class="full-width" style="margin-top: 2rem; margin-bottom: 1rem;">
              <h2 style="font-size: 1.5rem; color: #333; font-weight: 700;">ü§ù Need Help?</h2>
            </div>

            <div class="card">
              <h3>üí∞ Billing Questions</h3>
              <div class="card-content">
                <p style="color: #666; font-size: 0.95rem;">Questions about pricing, payments, or invoices?</p>
                <div class="card-footer" style="border: none; padding-top: 0;">
                  <a href="${MAILTO_LINKS.professionalPlan}" class="btn btn-primary" style="width: 100%;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                      <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                    Contact Billing
                  </a>
                </div>
              </div>
            </div>

            <div class="card">
              <h3>üîß Technical Support</h3>
              <div class="card-content">
                <p style="color: #666; font-size: 0.95rem;">Help with your account or platform features?</p>
                <div class="card-footer" style="border: none; padding-top: 0;">
                  <a href="mailto:${CONTACTS.support}" class="btn btn-secondary" style="width: 100%;">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 000 16zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    Get Support
                  </a>
                </div>
              </div>
            </div>

            <div class="card full-width">
              <h3>üìà Sales Team</h3>
              <div class="card-content">
                <div class="info-row">
                  <div class="info-text">
                    <span class="info-label">Custom Enterprise Solutions</span>
                    <span class="info-value">Discuss tailored plans for large scale testing directories.</span>
                  </div>
                  <a href="${MAILTO_LINKS.enterprisePlan}" class="btn btn-secondary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Talk to Sales
                  </a>
                </div>
              </div>
            </div>
          </div>
        `

      } catch (error) {
        console.error('Subscription page error:', error)
        contentDiv.innerHTML = `
          <div class="error-message">
            An unexpected error occurred. Please refresh the page. Details: ${error.message}
          </div>
        `
      }
    }

    // Listen for auth state changes
    supabaseBrowser.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        loadSubscriptionPage()
      } else if (event === 'SIGNED_OUT' || !session) {
        window.location.href = '/login'
      }
    })

    // Load immediately
    loadSubscriptionPage()

    // Export function to window so it can be called from HTML
    window.handlePayPalSubscribe = async function(tier, button) {
      const originalText = button.textContent;
      button.textContent = 'Processing...';
      button.disabled = true;

      try {
        const { data: { session } } = await supabaseBrowser.auth.getSession();
        if (!session) throw new Error('No active session');

        // Call Edge Function to create subscription
        const { data, error } = await fetch('https://haimjeaetrsaauitrhfy.supabase.co/functions/v1/paypal-create-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            tier,
            return_url: window.location.origin + '/checkout/success',
            cancel_url: window.location.origin + '/checkout/cancel'
          })
        }).then(res => res.json().then(data => ({ data, error: !res.ok ? data : null })));

        if (error) throw error;

        // Redirect to PayPal
        if (data.approval_url) {
          window.location.href = data.approval_url;
        } else {
          throw new Error('No approval URL returned');
        }

      } catch (error) {
        console.error('Subscription error:', error);
        alert('Failed to start checkout. Please try again or contact support.');
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    // Export handleCancelSubscription to window
    window.handleCancelSubscription = async function(button) {
      if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features immediately upon cancellation.')) {
        return;
      }

      const originalText = button.textContent;
      button.textContent = 'Cancelling...';
      button.disabled = true;

      try {
        const { data: { session } } = await supabaseBrowser.auth.getSession();
        if (!session) throw new Error('No active session');

        const { data, error } = await fetch('https://haimjeaetrsaauitrhfy.supabase.co/functions/v1/paypal-cancel-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${supabaseAnonJwt}`
          },
          body: JSON.stringify({
             userId: session.user.id,
             reason: 'User requested cancellation via dashboard'
          })
        }).then(res => res.json().then(data => ({ data, error: !res.ok ? data : null })));

        if (error) {
            console.error('Cancellation API Error:', error);
            throw new Error(error.error || 'Failed to cancel subscription');
        }

        alert('Subscription cancelled successfully.');
        window.location.reload();

      } catch (error) {
        console.error('Cancellation error:', error);
        alert(`Failed to cancel subscription: ${error.message}`);
        button.textContent = originalText;
        button.disabled = false;
      }
    }