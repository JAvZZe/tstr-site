---
export const prerender = false // Force SSR for auth page

// Import Supabase client
import { supabaseBrowser } from '../../lib/supabase-browser'
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - TSTR Hub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 3rem 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      opacity: 0.3;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }

    .breadcrumb {
      display: flex;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .breadcrumb a {
      color: white;
      text-decoration: none;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .breadcrumb a:hover {
      opacity: 1;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .metric-label {
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-change {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      display: inline-block;
    }

    .metric-change.positive {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
    }

    .metric-change.negative {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .chart-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
    }

    .chart-period {
      display: flex;
      gap: 0.5rem;
    }

    .period-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .period-btn.active {
      border-color: #667eea;
      background: #f8f9ff;
      color: #667eea;
    }

    .listings-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .table-header {
      background: #f8f9fa;
      padding: 1rem 2rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .table-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem 2rem;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background: #f9f9fa;
    }

    .listing-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .listing-category {
      color: #666;
      font-size: 0.85rem;
    }

    .metric-number {
      font-weight: 600;
      color: #333;
    }

    .metric-trend {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
    }

    .metric-trend.positive {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
    }

    .metric-trend.negative {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .no-data h3 {
      margin-bottom: 0.5rem;
      color: #333;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .back-link {
      display: inline-block;
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 1rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #764ba2;
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .chart-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .chart-period {
        width: 100%;
        justify-content: center;
      }

      .period-btn {
        flex: 1;
      }

      table {
        font-size: 0.9rem;
      }

      th, td {
        padding: 0.75rem 1rem;
      }

      header {
        padding: 1.5rem 1rem;
      }

      .container {
        padding: 0 1rem;
      }

      .metric-card {
        padding: 1.5rem;
      }

      .metric-value {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><a href="/">TSTR Hub</a></h1>
    <p>Listing Analytics Dashboard</p>
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>›</span>
      <a href="/account">Account</a>
      <span>›</span>
      <span>Analytics</span>
    </div>
  </header>

  <div class="container">
    <a href="/account" class="back-link">← Back to Account</a>

    <div id="content">
      <div class="loading">Loading your analytics...</div>
    </div>
  </div>

  <script>
    import { supabaseBrowser } from '../../lib/supabase-browser'

    async function loadAnalytics() {
      const contentDiv = document.getElementById('content')

      try {
        // Get current session
        const { data: { session }, error: sessionError } = await supabaseBrowser.auth.getSession()

        if (sessionError || !session) {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname)
          return
        }

        const user = session.user

        // Get user's owned listings
        const { data: ownedListings, error: ownershipError } = await supabaseBrowser
          .from('listing_owners')
          .select(`
            listing_id,
            status,
            listing:listings (
              id,
              business_name,
              website,
              category:category_id (name)
            )
          `)
          .eq('user_id', user.id)
          .eq('status', 'verified')

        if (ownershipError) {
          console.error('Ownership fetch error:', ownershipError)
          contentDiv.innerHTML = '<div class="error-message">Failed to load your listings. Please try again.</div>'
          return
        }

        if (!ownedListings || ownedListings.length === 0) {
          contentDiv.innerHTML = `
            <div class="no-data">
              <h3>No Analytics Available</h3>
              <p>You don't have any verified listings yet. Claim a listing to start seeing analytics.</p>
              <a href="/browse" style="color: #667eea; text-decoration: none; font-weight: 500;">Browse Listings →</a>
            </div>
          `
          return
        }

        const listingIds = ownedListings.map(item => item.listing_id)

        // Get analytics data for owned listings
        const now = new Date()
        const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
        const last7Days = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)

        // Total clicks for owned listings
        const { count: totalClicks } = await supabaseBrowser
          .from('clicks')
          .select('*', { count: 'exact', head: true })
          .in('listing_id', listingIds)

        // Clicks in last 30 days
        const { count: clicks30d } = await supabaseBrowser
          .from('clicks')
          .select('*', { count: 'exact', head: true })
          .in('listing_id', listingIds)
          .gte('created_at', last30Days.toISOString())

        // Clicks in last 7 days
        const { count: clicks7d } = await supabaseBrowser
          .from('clicks')
          .select('*', { count: 'exact', head: true })
          .in('listing_id', listingIds)
          .gte('created_at', last7Days.toISOString())

        // Get per-listing analytics
        const { data: listingClicks, error: clicksError } = await supabaseBrowser
          .from('clicks')
          .select(`
            listing_id,
            created_at,
            listings (
              business_name,
              website,
              category:category_id (name)
            )
          `)
          .in('listing_id', listingIds)
          .order('created_at', { ascending: false })

        if (clicksError) {
          console.error('Clicks fetch error:', clicksError)
        }

        // Process per-listing data
        const listingStats = {}
        ownedListings.forEach(item => {
          const listing = item.listing
          listingStats[listing.id] = {
            name: listing.business_name,
            website: listing.website,
            category: listing.category?.name || 'Uncategorized',
            totalClicks: 0,
            clicks30d: 0,
            clicks7d: 0,
            lastClick: null
          }
        })

        // Aggregate click data
        if (listingClicks) {
          listingClicks.forEach(click => {
            const listingId = click.listing_id
            if (listingStats[listingId]) {
              listingStats[listingId].totalClicks++
              listingStats[listingId].lastClick = click.created_at

              const clickDate = new Date(click.created_at)
              if (clickDate >= last30Days) {
                listingStats[listingId].clicks30d++
              }
              if (clickDate >= last7Days) {
                listingStats[listingId].clicks7d++
              }
            }
          })
        }

        // Convert to array and sort by total clicks
        const sortedListings = Object.values(listingStats)
          .sort((a, b) => b.totalClicks - a.totalClicks)

        // Calculate trends (simplified - comparing 7d vs 30d average)
        const totalClicks7d = sortedListings.reduce((sum, listing) => sum + listing.clicks7d, 0)
        const avgClicksPerDay7d = totalClicks7d / 7
        const avgClicksPerDay30d = (clicks30d || 0) / 30
        const trend = avgClicksPerDay7d > avgClicksPerDay30d ? 'positive' : 'negative'
        const trendPercent = avgClicksPerDay30d > 0 ?
          Math.round(((avgClicksPerDay7d - avgClicksPerDay30d) / avgClicksPerDay30d) * 100) : 0

        // Render analytics dashboard
        contentDiv.innerHTML = `
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value">${totalClicks || 0}</div>
              <div class="metric-label">Total Clicks</div>
              <div class="metric-change ${trend}">${trendPercent > 0 ? '+' : ''}${trendPercent}% vs last month</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${clicks30d || 0}</div>
              <div class="metric-label">Clicks (30 Days)</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${clicks7d || 0}</div>
              <div class="metric-label">Clicks (7 Days)</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">${ownedListings.length}</div>
              <div class="metric-label">Active Listings</div>
            </div>
          </div>

          <div class="listings-table">
            <div class="table-header">
              <h3 class="table-title">Performance by Listing</h3>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Listing</th>
                  <th>Total Clicks</th>
                  <th>Last 30 Days</th>
                  <th>Last 7 Days</th>
                  <th>Last Click</th>
                </tr>
              </thead>
              <tbody>
                ${sortedListings.map(listing => `
                  <tr>
                    <td>
                      <div class="listing-name">${listing.name}</div>
                      <div class="listing-category">${listing.category}</div>
                    </td>
                    <td><span class="metric-number">${listing.totalClicks}</span></td>
                    <td><span class="metric-number">${listing.clicks30d}</span></td>
                    <td><span class="metric-number">${listing.clicks7d}</span></td>
                    <td>${listing.lastClick ? new Date(listing.lastClick).toLocaleDateString() : 'Never'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `

      } catch (error) {
        console.error('Analytics load error:', error)
        contentDiv.innerHTML = `
          <div class="error-message">
            An unexpected error occurred. Please refresh the page.
          </div>
        `
      }
    }

    // Listen for auth state changes
    supabaseBrowser.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        loadAnalytics()
      } else if (event === 'SIGNED_OUT' || !session) {
        window.location.href = '/login'
      }
    })

    // Try to load immediately
    loadAnalytics()
  </script>
</body>
</html>